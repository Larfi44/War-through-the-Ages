<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>War through the Ages</title>
    <link rel="icon" type="image/svg+xml" href="images/avatar.svg" />
    <style>
      :root {
        --bg: #071022;
        --panel: #0b1220;
        --accent: #ffcc00;
        --text: #e6eef8;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        overflow: hidden;
      }
      body {
        margin: 0;
        padding: 12px;
        font-family: Inter, system-ui, Arial;
        -webkit-font-smoothing: antialiased;
        background: linear-gradient(180deg, #041224 0%, #07122a 100%);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .card {
        width: 100%;
        max-width: 1100px;
        border-radius: 12px;
        padding: 10px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.005)
        );
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      #gold,
      #xp,
      #ageText {
        color: #ffcc00 !important;
        font-size: 16px !important;
        font-weight: bold !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
      .language-switcher {
        display: flex;
        gap: 4px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.02)
        );
        border-radius: 10px;
        padding: 4px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .lang-option {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 7px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 13px;
        color: #9fb0d0;
        position: relative;
        overflow: hidden;
      }
      .lang-option::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transition: left 0.5s;
      }
      .lang-option:hover::before {
        left: 100%;
      }
      .lang-option:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        transform: translateY(-1px);
      }
      .lang-option.active {
        background: linear-gradient(
          135deg,
          rgba(255, 204, 0, 0.2),
          rgba(255, 204, 0, 0.1)
        );
        color: #ffcc00;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(255, 204, 0, 0.2);
      }
      .lang-flag {
        font-size: 15px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
      }
      .lang-text {
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.3px;
      }
      .battleWrap {
        width: 100%;
        max-width: 980px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }
      .battle {
        width: 100%;
        height: 520px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.005),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 10px;
        position: relative;
        overflow: hidden;
      }
      .topBossInfo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 10px;
        background: rgba(0, 0, 0, 0.45);
        padding: 8px 12px;
        border-radius: 8px;
        z-index: 40;
        display: flex;
        gap: 10px;
        align-items: center;
        font-weight: 700;
      }
      .topBossInfo .small {
        font-weight: 400;
        color: #9fb0d0;
        font-size: 13px;
      }
      .ground {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 12%;
        height: 8px;
        background: #213444;
        border-radius: 4px;
        z-index: 20;
      }
      .base {
        position: absolute;
        bottom: 14%;
        width: 140px;
        height: 140px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        z-index: 30;
      }
      .base.player {
        left: 10px;
        background: linear-gradient(180deg, #ffd57a, #ffb84d);
        color: #07122a;
      }
      .base.enemy {
        right: 10px;
        background: linear-gradient(180deg, #ffdce5, #ff89a1);
        color: #07122a;
      }
      .unit {
        position: absolute;
        z-index: 32;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
        pointer-events: none;
      }
      .unit img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .bossUnit {
        position: absolute;
        z-index: 35;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .bossUnit img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .hpBar {
        position: absolute;
        left: 0;
        right: 0;
        height: 6px;
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.45);
        top: -10px;
        overflow: hidden;
        z-index: 10;
      }
      .hpFill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        width: 100%;
      }
      .hpFill.low {
        background: linear-gradient(90deg, #f97316, #ef4444);
      }
      .proj {
        position: absolute;
        pointer-events: none;
        z-index: 33;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .proj img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .bottomBar {
        width: 100%;
        max-width: 980px;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.55),
          rgba(2, 6, 23, 0.3)
        );
        padding: 10px;
        border-radius: 10px;
        z-index: 50;
      }
      .stat {
        min-width: 100px;
        background: rgba(255, 255, 255, 0.03);
        padding: 8px;
        border-radius: 8px;
        text-align: center;
      }
      #ageText {
        font-size: 14px;
      }
      .unitButtons {
        flex: 1;
        display: flex;
        gap: 8px;
        overflow: auto;
        padding: 4px 2px;
      }
      .unitButtons.no-scroll {
        overflow: visible;
        flex-wrap: wrap;
        justify-content: center;
      }
      .unit-btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 8px;
        padding: 8px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        white-space: nowrap;
        flex-shrink: 0;
        width: 80px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        text-align: center;
      }
      .unit-btn .unit-name {
        font-size: 12px;
        font-weight: 600;
        line-height: 1.2;
      }
      .unit-btn .unit-cost {
        font-size: 11px;
        color: #ffcc00;
        font-weight: 700;
      }
      .btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 8px;
        padding: 8px 10px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.2s;
      }
      .btn.active {
        background: linear-gradient(180deg, #1e293b, #0f1724);
        outline: 2px solid rgba(255, 204, 0, 0.3);
      }
      .small {
        font-size: 13px;
        color: #9fb0d0;
      }
      .speedBtn.active {
        outline: 2px solid rgba(255, 204, 0, 0.12);
      }
      .hackPopup {
        position: absolute;
        bottom: 48px;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        padding: 8px;
        border-radius: 8px;
        display: none;
        flex-direction: column;
        gap: 6px;
      }
      .centerRow {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      #pauseModal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.6);
        z-index: 220;
      }
      #pauseCard {
        background: linear-gradient(180deg, #07122a, #091428);
        padding: 16px;
        border-radius: 12px;
        width: 420px;
        max-width: 92vw;
        text-align: center;
      }
      #finishOverlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.75);
        z-index: 300;
      }
      #finishCard {
        background: linear-gradient(180deg, #07122a, #091428);
        padding: 16px;
        border-radius: 12px;
        width: 420px;
        max-width: 92vw;
        text-align: center;
      }
      .locked {
        opacity: 0.6;
        filter: brightness(0.7);
      }
      .upgrade-age-blink {
        animation: upgradeBlink 1s infinite;
        background: linear-gradient(180deg, #ffcc00, #ffaa00) !important;
        color: #07122a !important;
      }
      @keyframes upgradeBlink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }
      .orientation-warning {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        font-size: 18px;
      }
      .settings-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: center;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      .setting-label {
        font-size: 14px;
        color: #9fb0d0;
        min-width: 120px;
      }
      .setting-control {
        flex: 1;
        display: flex;
        justify-content: flex-end;
      }
      select {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 6px 10px;
        color: var(--text);
        min-width: 140px;
      }
      input[type="range"] {
        width: 140px;
      }
      .boss-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 4px 0;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .boss-item:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .boss-item.selected {
        outline: 2px solid rgba(255, 204, 0, 0.3);
        background: rgba(255, 204, 0, 0.05);
      }
      .boss-info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .boss-name {
        font-weight: 600;
        font-size: 14px;
      }
      .boss-age {
        font-size: 12px;
        color: #9fb0d0;
        margin-top: 2px;
      }
      .boss-status {
        font-size: 12px;
        color: #9fb0d0;
      }
      .difficulty-switcher {
        display: flex;
        gap: 4px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 4px;
      }
      .diff-btn {
        flex: 1;
        padding: 6px 12px;
        border: none;
        background: transparent;
        color: var(--text);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 12px;
      }
      .diff-btn.active {
        background: rgba(255, 204, 0, 0.15);
        color: #ffcc00;
        font-weight: 600;
      }
      .upgrade-age-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }
      .upgrade-age-square {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        padding: 8px;
      }
      .upgrade-age-square:hover {
        background: linear-gradient(180deg, #1e293b, #0f1724);
      }
      .upgrade-age-square.upgrade-age-blink {
        animation: upgradeBlink 1s infinite;
        background: linear-gradient(180deg, #ffcc00, #ffaa00) !important;
        color: #07122a !important;
      }
      .upgrade-age-text {
        font-size: 11px;
        font-weight: 600;
        line-height: 1.2;
        margin-bottom: 4px;
      }
      .upgrade-age-cost {
        font-size: 10px;
        color: #ffcc00;
        font-weight: 700;
      }
      #menuBackground {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: -1;
        overflow: hidden;
      }
      .menu-unit {
        position: absolute;
        z-index: 1;
        pointer-events: none;
      }
      .menu-unit img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .unit[data-unit-type="tank"],
      .bossUnit[data-boss="hitler"] {
        bottom: 8% !important;
      }

      /* Mobile Optimizations */
      .mobile-controls {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(2, 6, 23, 0.95);
        padding: 10px;
        z-index: 100;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .mobile-stats {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(2, 6, 23, 0.95);
        padding: 8px;
        z-index: 100;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 12px;
      }

      .mobile-stats-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mobile-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
      }

      .mobile-stat-value {
        font-weight: bold;
        color: #ffcc00;
        font-size: 14px;
      }

      .mobile-boss-info {
        display: none;
        position: fixed;
        top: 50px;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        padding: 6px;
        z-index: 99;
        text-align: center;
        font-size: 11px;
      }

      .mobile-unit-buttons {
        display: none;
        position: fixed;
        bottom: 70px;
        left: 0;
        right: 0;
        background: rgba(2, 6, 23, 0.9);
        padding: 8px;
        z-index: 90;
        overflow-x: auto;
        gap: 6px;
      }

      .mobile-unit-btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 6px;
        padding: 6px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        white-space: nowrap;
        flex-shrink: 0;
        width: 60px;
        height: 45px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        text-align: center;
        font-size: 10px;
      }

      .mobile-unit-btn .unit-name {
        font-size: 9px;
        font-weight: 600;
        line-height: 1.1;
      }

      .mobile-unit-btn .unit-cost {
        font-size: 8px;
        color: #ffcc00;
        font-weight: 700;
      }

      .mobile-upgrade-btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-width: 60px;
      }

      .mobile-upgrade-btn .upgrade-text {
        font-size: 9px;
        font-weight: 600;
      }

      .mobile-upgrade-btn .upgrade-cost {
        font-size: 8px;
        color: #ffcc00;
        font-weight: 700;
      }

      .mobile-controls-row {
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
      }

      .mobile-speed-controls {
        display: flex;
        gap: 4px;
      }

      .mobile-speed-btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 6px;
        padding: 6px 8px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        font-size: 10px;
      }

      .mobile-speed-btn.active {
        background: linear-gradient(180deg, #1e293b, #0f1724);
        outline: 1px solid rgba(255, 204, 0, 0.3);
      }

      .mobile-action-btns {
        display: flex;
        gap: 6px;
      }

      .mobile-action-btn {
        background: linear-gradient(180deg, #0f1724, #08101a);
        border-radius: 6px;
        padding: 6px 10px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--text);
        font-size: 10px;
        white-space: nowrap;
      }

      /* Double click animation */
      .boss-double-click {
        animation: doubleClickPulse 0.6s ease;
      }

      @keyframes doubleClickPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
          background: rgba(255, 204, 0, 0.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Ultra-compact mobile layout for 275px height */
      @media (max-height: 275px) and (orientation: landscape) {
        .mobile-stats {
          padding: 4px;
          font-size: 10px;
        }

        .mobile-stat-value {
          font-size: 12px;
        }

        .mobile-boss-info {
          top: 35px;
          padding: 4px;
          font-size: 9px;
        }

        .mobile-unit-buttons {
          bottom: 45px;
          padding: 6px;
          gap: 4px;
        }

        .mobile-unit-btn {
          width: 50px;
          height: 40px;
          padding: 4px;
        }

        .mobile-unit-btn .unit-name {
          font-size: 8px;
        }

        .mobile-unit-btn .unit-cost {
          font-size: 7px;
        }

        .mobile-controls {
          padding: 6px;
        }

        .mobile-upgrade-btn {
          min-width: 50px;
          padding: 6px;
        }

        .mobile-upgrade-btn .upgrade-text {
          font-size: 8px;
        }

        .mobile-upgrade-btn .upgrade-cost {
          font-size: 7px;
        }

        .mobile-speed-btn {
          padding: 4px 6px;
          font-size: 9px;
        }

        .mobile-action-btn {
          padding: 4px 8px;
          font-size: 9px;
        }

        .battle {
          margin-top: 30px;
          margin-bottom: 45px;
          height: calc(100vh - 75px);
          min-height: 180px;
        }

        .base {
          width: 60px;
          height: 60px;
          font-size: 10px;
          bottom: 12%;
        }

        .base.player,
        .base.enemy {
          font-size: 9px;
        }

        .ground {
          bottom: 10%;
          height: 6px;
        }

        .unit {
          bottom: 11% !important;
        }

        .bossUnit {
          bottom: 11% !important;
        }

        .hpBar {
          top: -8px;
          height: 4px;
        }

        #pHP,
        #eHP {
          font-size: 10px;
        }
      }

      /* Ultra-compact layout for very small screens (150px height) */
      @media (max-height: 150px) and (orientation: landscape) {
        body {
          padding: 4px;
        }

        .card {
          padding: 4px;
          gap: 4px;
        }

        .mobile-stats {
          padding: 2px;
          font-size: 8px;
        }

        .mobile-stat-value {
          font-size: 10px;
        }

        .mobile-boss-info {
          top: 25px;
          padding: 2px;
          font-size: 7px;
        }

        .mobile-unit-buttons {
          bottom: 35px;
          padding: 4px;
          gap: 2px;
        }

        .mobile-unit-btn {
          width: 40px;
          height: 30px;
          padding: 2px;
        }

        .mobile-unit-btn .unit-name {
          font-size: 6px;
        }

        .mobile-unit-btn .unit-cost {
          font-size: 5px;
        }

        .mobile-controls {
          padding: 4px;
        }

        .mobile-upgrade-btn {
          min-width: 40px;
          padding: 4px;
        }

        .mobile-upgrade-btn .upgrade-text {
          font-size: 6px;
        }

        .mobile-upgrade-btn .upgrade-cost {
          font-size: 5px;
        }

        .mobile-speed-btn {
          padding: 2px 4px;
          font-size: 7px;
        }

        .mobile-action-btn {
          padding: 2px 6px;
          font-size: 7px;
        }

        .battle {
          margin-top: 25px;
          margin-bottom: 35px;
          height: calc(100vh - 60px);
          min-height: 100px;
        }

        .base {
          width: 40px;
          height: 40px;
          font-size: 8px;
          bottom: 10%;
        }

        .base.player,
        .base.enemy {
          font-size: 7px;
        }

        .ground {
          bottom: 8%;
          height: 4px;
        }

        .unit {
          bottom: 9% !important;
        }

        .bossUnit {
          bottom: 9% !important;
        }

        .hpBar {
          top: -6px;
          height: 3px;
        }

        #pHP,
        #eHP {
          font-size: 8px;
        }

        .topBossInfo {
          font-size: 10px;
          padding: 4px 8px;
        }

        .topBossInfo .small {
          font-size: 9px;
        }
      }

      @media (max-width: 900px) {
        .battle {
          height: 440px;
        }
        .base {
          width: 110px;
          height: 110px;
        }
        .bossUnit {
          width: 56px;
          height: 56px;
        }
        .unit-btn {
          width: 70px;
          height: 70px;
        }
        .unit-btn .unit-name {
          font-size: 11px;
        }
        .upgrade-age-square {
          width: 70px;
          height: 70px;
        }
        .upgrade-age-text {
          font-size: 10px;
        }
      }

      @media (max-width: 768px) {
        .bottomBar,
        .topBossInfo {
          display: none !important;
        }

        .mobile-stats,
        .mobile-boss-info,
        .mobile-unit-buttons,
        .mobile-controls {
          display: flex;
        }

        .battle {
          margin-top: 40px;
          margin-bottom: 120px;
          height: calc(100vh - 160px);
          min-height: 300px;
        }

        .mobile-unit-buttons {
          bottom: 60px;
        }
      }

      @media (max-width: 520px) and (orientation: portrait) {
        .orientation-warning {
          display: flex;
        }
        .card,
        .battleWrap {
          display: none;
        }
      }

      @media (max-width: 520px) and (orientation: landscape) {
        .bottomBar,
        .topBossInfo {
          display: none !important;
        }

        .mobile-stats,
        .mobile-boss-info,
        .mobile-unit-buttons,
        .mobile-controls {
          display: flex;
        }

        .battle {
          margin-top: 35px;
          margin-bottom: 50px;
          height: calc(100vh - 85px);
          min-height: 200px;
        }

        .mobile-unit-buttons {
          bottom: 50px;
        }

        .base {
          width: 80px;
          height: 80px;
          font-size: 12px;
        }
      }

      @media (max-height: 400px) and (orientation: landscape) {
        .battle {
          height: 250px;
          margin-top: 30px;
          margin-bottom: 45px;
        }
        .base {
          width: 70px;
          height: 70px;
          font-size: 11px;
        }
      }
    </style>
  </head>
  <body>
    <div class="orientation-warning" id="orientationWarning">
      <div>
        <h3>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –∞–ª—å–±–æ–º–Ω—ã–π —Ä–µ–∂–∏–º</h3>
        <p>
          –≠—Ç–∞ –∏–≥—Ä–∞ –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
          —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        </p>
      </div>
    </div>

    <!-- Mobile UI Elements -->
    <div class="mobile-stats" id="mobileStats">
      <div class="mobile-stats-row">
        <div class="mobile-stat">
          <div>Gold</div>
          <div class="mobile-stat-value" id="mobileGold">0</div>
        </div>
        <div class="mobile-stat">
          <div>XP</div>
          <div class="mobile-stat-value" id="mobileXP">0</div>
        </div>
        <div class="mobile-stat">
          <div>Age</div>
          <div class="mobile-stat-value" id="mobileAge">Ancient</div>
        </div>
      </div>
    </div>

    <div class="mobile-boss-info" id="mobileBossInfo">
      Without boss ‚Ä¢ Difficulty: medium ‚Ä¢ Enemy age: Ancient World
    </div>

    <div class="mobile-unit-buttons" id="mobileUnitButtons">
      <!-- Mobile unit buttons will be populated here -->
    </div>

    <div class="mobile-controls" id="mobileControls">
      <div class="mobile-controls-row">
        <div class="mobile-upgrade-btn" id="mobileUpgradeAge">
          <div class="upgrade-text">Upgrade</div>
          <div class="upgrade-cost" id="mobileAgeCost">0/200</div>
        </div>

        <div class="mobile-speed-controls">
          <button class="mobile-speed-btn active" data-speed="1">x1</button>
          <button class="mobile-speed-btn" data-speed="1.5">x1.5</button>
          <button class="mobile-speed-btn" data-speed="2">x2</button>
        </div>

        <div class="mobile-action-btns">
          <button class="mobile-action-btn" id="mobileMenuBtn">Menu</button>
          <button class="mobile-action-btn" id="mobileHackBtn">Hack</button>
        </div>
      </div>
    </div>

    <!-- Rest of your existing HTML remains the same -->
    <audio id="mainMusic" loop preload="auto">
      <source src="music/main.mp3" type="audio/mpeg" />
    </audio>
    <audio id="bossMusic" loop preload="auto">
      <source src="music/boss.mp3" type="audio/mpeg" />
    </audio>
    <audio id="ancientMusic" loop preload="auto">
      <source src="music/ancient.mp3" type="audio/mpeg" />
    </audio>
    <audio id="antiquityMusic" loop preload="auto">
      <source src="music/antiquity.mp3" type="audio/mpeg" />
    </audio>
    <audio id="medievalMusic" loop preload="auto">
      <source src="music/medieval.mp3" type="audio/mpeg" />
    </audio>
    <audio id="enlightenmentMusic" loop preload="auto">
      <source src="music/enlightenment.mp3" type="audio/mpeg" />
    </audio>
    <audio id="modernMusic" loop preload="auto">
      <source src="music/modern.mp3" type="audio/mpeg" />
    </audio>
    <audio id="futureMusic" loop preload="auto">
      <source src="music/future.mp3" type="audio/mpeg" />
    </audio>
    <audio id="menuMusic" loop preload="auto">
      <source src="music/menu.mp3" type="audio/mpeg" />
    </audio>

    <div class="card" id="root">
      <div
        id="menu"
        style="
          position: fixed;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(2, 6, 23, 0.75);
          z-index: 200;
        "
      >
        <div
          style="
            background: linear-gradient(180deg, #07122a, #091428);
            padding: 20px;
            border-radius: 12px;
            width: 920px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
          "
        >
          <h2 id="title" style="text-align: center; margin-bottom: 20px">
            War through the Ages
          </h2>
          <div
            style="
              display: flex;
              gap: 8px;
              margin-top: 8px;
              justify-content: center;
            "
          >
            <button id="btnNormal" class="btn">Normal</button>
            <button id="btnBosses" class="btn">Bosses</button>
            <button id="btnSettings" class="btn">Settings</button>
          </div>

          <div id="menuPanels" style="margin-top: 20px">
            <div id="panelNormal" style="display: none">
              <div class="settings-container">
                <div class="setting-row">
                  <div class="setting-label" id="lblDiff">Difficulty</div>
                  <div class="setting-control">
                    <div class="difficulty-switcher">
                      <button class="diff-btn" data-diff="easy">Easy</button>
                      <button class="diff-btn active" data-diff="medium">
                        Medium
                      </button>
                      <button class="diff-btn" data-diff="hard">Hard</button>
                    </div>
                  </div>
                </div>
                <div style="margin-top: 20px; text-align: center">
                  <button
                    id="startNormal"
                    class="btn"
                    style="padding: 10px 20px"
                  >
                    Start Normal (no boss)
                  </button>
                </div>
              </div>
            </div>

            <div id="panelBosses" style="display: none">
              <div
                style="
                  margin-bottom: 10px;
                  text-align: center;
                  font-size: 12px;
                  color: #9fb0d0;
                "
              >
                Click to select, double-click to start
              </div>
              <div
                id="bossList"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 15px"
              ></div>
              <div style="text-align: center">
                <button id="startBoss" class="btn" style="padding: 10px 20px">
                  Start Boss Match
                </button>
              </div>
            </div>

            <div id="panelSettings" style="display: none">
              <div class="settings-container">
                <div class="setting-row">
                  <div class="setting-label" id="lblLang">Language</div>
                  <div class="setting-control">
                    <div class="language-switcher">
                      <div class="lang-option" data-lang="en">
                        <span class="lang-flag">üá∫üá∏</span
                        ><span class="lang-text">English</span>
                      </div>
                      <div class="lang-option" data-lang="ru">
                        <span class="lang-flag">üá∑üá∫</span
                        ><span class="lang-text">–†—É—Å—Å–∫–∏–π</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="setting-row">
                  <div class="setting-label" id="lblVolume">Volume</div>
                  <div class="setting-control">
                    <input id="vol" type="range" min="0" max="100" value="80" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="battleWrap">
        <div class="battle" id="battle">
          <div class="topBossInfo" id="topInfo">
            <div id="topLeft">Without boss</div>
            <div id="topMid" class="small">Difficulty: medium</div>
            <div id="topAge" class="small">Enemy age: Ancient World</div>
          </div>

          <div id="battleArea" class="battleArea">
            <div class="base player" id="playerBase">
              <div id="lblYou">YOU</div>
              <div id="pHP">0</div>
            </div>
            <div class="base enemy" id="enemyBase">
              <div id="lblEnemy">ENEMY</div>
              <div id="eHP">0</div>
            </div>
            <div class="ground"></div>
            <div
              id="battleUnits"
              style="position: absolute; left: 0; right: 0; top: 0; bottom: 0"
            ></div>
          </div>
        </div>

        <div class="bottomBar">
          <div style="display: flex; gap: 8px; align-items: center">
            <div class="stat" id="statGold">
              Gold<br /><strong id="gold">0</strong>
            </div>
            <div class="stat" id="statXP">
              XP<br /><strong id="xp">0</strong>
            </div>
            <div class="stat" id="statAge">
              Age<br /><strong id="ageText">Ancient World</strong>
            </div>
          </div>

          <div class="unitButtons" id="unitButtons"></div>

          <div style="display: flex; gap: 8px; align-items: center">
            <div class="upgrade-age-container">
              <div id="upgradeAge" class="upgrade-age-square">
                <div class="upgrade-age-text">Upgrade Age</div>
                <div class="upgrade-age-cost" id="ageCost">0/200</div>
              </div>
            </div>

            <div style="display: flex; gap: 6px; align-items: center">
              <button class="btn speedBtn active" data-speed="1">x1</button>
              <button class="btn speedBtn" data-speed="1.5">x1.5</button>
              <button class="btn speedBtn" data-speed="2">x2</button>
            </div>

            <div style="position: relative">
              <button id="hackBtn" class="btn">Hack</button>
              <div class="hackPopup" id="hackPopup">
                <label style="display: flex; gap: 6px; align-items: center">
                  <input id="infGold" type="checkbox" />
                  <span class="small" id="hackLabelGold">Infinite Gold</span>
                </label>
                <label style="display: flex; gap: 6px; align-items: center">
                  <input id="infXP" type="checkbox" />
                  <span class="small" id="hackLabelXP">Infinite XP</span>
                </label>
                <label style="display: flex; gap: 6px; align-items: center">
                  <input id="stopEnemySpawn" type="checkbox" />
                  <span class="small" id="hackLabelNoSpawn"
                    >Enemy doesn't spawn</span
                  >
                </label>
                <button id="pauseTimeBtn" class="btn">Pause Time</button>
                <button id="killEnemyBtn" class="btn">
                  Kill All Enemy Units
                </button>
                <button id="killPlayerBtn" class="btn">
                  Kill All Your Units
                </button>
              </div>
            </div>

            <button id="menuBtn" class="btn">Menu</button>
          </div>
        </div>
      </div>
    </div>

    <div id="pauseModal">
      <div id="pauseCard">
        <h3 id="pauseTitle">Paused</h3>
        <div
          style="
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: center;
          "
        >
          <button id="pauseCancel" class="btn">Cancel (Resume)</button>
          <button id="pauseMenu" class="btn">Return to Menu</button>
        </div>
      </div>
    </div>

    <div id="finishOverlay">
      <div id="finishCard">
        <h2 id="finishTitle">Result</h2>
        <div id="finishMessage" style="margin-top: 8px"></div>
        <div
          style="
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
          "
        >
          <button id="finishRestart" class="btn">Restart</button>
          <button id="finishToMenu" class="btn">Menu</button>
        </div>
      </div>
    </div>

    <script>
      // Game constants and data
      const AGES = [
        { id: 1, name: "Ancient World", ru: "–ö–∞–º–µ–Ω–Ω—ã–π –≤–µ–∫" },
        { id: 2, name: "Antiquity", ru: "–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å" },
        { id: 3, name: "Medieval", ru: "–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ" },
        { id: 4, name: "Age of Enlightenment", ru: "–≠–ø–æ—Ö–∞ –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è" },
        { id: 5, name: "Modern Time", ru: "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è" },
        { id: 6, name: "Future", ru: "–ë—É–¥—É—â–µ–µ" },
      ];

      const BOSSES = [
        {
          id: 1,
          name: "Kronos",
          ru: "–ö—Ä–æ–Ω–æ—Å",
          age: 1,
          baseHP: 1000,
          accel: 1.15,
          spawnRules: { allowMediumAfter: 10, allowHeavyAfter: 20 },
          imgWidth: 100,
          imgHeight: 100,
        },
        {
          id: 2,
          name: "Yuri Caesar",
          ru: "–Æ—Ä–∏–π –¶–µ–∑–∞—Ä—å",
          age: 2,
          baseHP: 3000,
          accel: 1,
          spawnRules: { allowMediumAfter: 15, allowHeavyAfter: 30 },
          imgWidth: 100,
          imgHeight: 100,
        },
        {
          id: 3,
          name: "Ivan the Terrible",
          ru: "–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π",
          age: 3,
          baseHP: 7000,
          accel: 1,
          spawnRules: { allowMediumAfter: 30, allowHeavyAfter: 40 },
          imgWidth: 100,
          imgHeight: 100,
        },
        {
          id: 4,
          name: "Napoleon Bonaparte",
          ru: "–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç",
          age: 4,
          accel: 1,
          baseHP: 15000,
          spawnRules: { allowMediumAfter: 35, allowHeavyAfter: 50 },
          imgWidth: 100,
          imgHeight: 100,
        },
        {
          id: 5,
          name: "Adolf Hitler",
          ru: "–ê–¥–æ–ª—å—Ñ –ì–∏—Ç–ª–µ—Ä",
          age: 5,
          accel: 1,
          baseHP: 30000,
          spawnRules: { allowMediumAfter: 45, allowHeavyAfter: 70 },
          imgWidth: 150,
          imgHeight: 150,
        },
        {
          id: 6,
          name: "Lord Yaroslav",
          ru: "–õ–æ—Ä–¥ –Ø—Ä–æ—Å–ª–∞–≤",
          age: 6,
          accel: 1,
          baseHP: 100000,
          spawnRules: { allowMediumAfter: 35, allowHeavyAfter: 75 },
          imgWidth: 100,
          imgHeight: 100,
        },
      ];

      const HP_PER_AGE = [100, 200, 400, 800, 1600, 3000];

      const UNIT_TEMPLATES = {
        1: [
          {
            id: "u1_m",
            name: "Warrior",
            ru: "–í–æ–∏–Ω",
            cost: 25,
            hp: 60,
            atk: 10,
            spd: 0.6,
            atkSpeed: 1.0,
            type: "melee",
            tier: 1,
            imgWidth: 60,
            imgHeight: 60,
          },
          {
            id: "u1_s",
            name: "Hunter",
            ru: "–û—Ö–æ—Ç–Ω–∏–∫",
            cost: 45,
            hp: 36,
            atk: 12,
            spd: 0.6,
            atkSpeed: 2.5,
            type: "shoot",
            range: 200,
            bulletSpeed: 420,
            bulletSize: 20,
            bulletSprite: {
              player: {
                src: "images/ancientBullet.svg",
                width: 20,
                height: 20,
              },
              enemy: { src: "images/ancientBullet.svg", width: 20, height: 20 },
            },
            tier: 2,
            imgWidth: 60,
            imgHeight: 60,
          },
          {
            id: "u1_h",
            name: "Brute",
            ru: "–ì—Ä–æ–º–∏–ª–∞",
            cost: 65,
            hp: 140,
            atk: 20,
            spd: 0.48,
            atkSpeed: 1.4,
            type: "melee",
            tier: 3,
            imgWidth: 70,
            imgHeight: 70,
          },
        ],
        2: [
          {
            id: "u2_m",
            name: "Legionary",
            ru: "–õ–µ–≥–∏–æ–Ω–µ—Ä",
            cost: 40,
            hp: 95,
            atk: 16,
            spd: 0.55,
            atkSpeed: 1.1,
            type: "melee",
            tier: 1,
            imgWidth: 65,
            imgHeight: 65,
          },
          {
            id: "u2_s",
            name: "Spearman",
            ru: "–ö–æ–ø–µ–π—â–∏–∫",
            cost: 55,
            hp: 56,
            atk: 18,
            spd: 0.48,
            atkSpeed: 2.8,
            type: "shoot",
            range: 250,
            bulletSpeed: 360,
            bulletSize: 20,
            bulletSprite: {
              player: {
                src: "images/antiquityBullet.svg",
                width: 20,
                height: 20,
              },
              enemy: {
                src: "images/antiquityBulletE.svg",
                width: 20,
                height: 20,
              },
            },
            tier: 2,
            imgWidth: 70,
            imgHeight: 70,
          },
          {
            id: "u2_h",
            name: "Veteran",
            ru: "–í–µ—Ç–µ—Ä–∞–Ω",
            cost: 100,
            hp: 230,
            atk: 30,
            spd: 0.48,
            atkSpeed: 1.3,
            type: "melee",
            tier: 3,
            imgWidth: 75,
            imgHeight: 75,
          },
        ],
        3: [
          {
            id: "u3_m",
            name: "Knight",
            ru: "–†—ã—Ü–∞—Ä—å",
            cost: 60,
            hp: 140,
            atk: 26,
            spd: 0.45,
            atkSpeed: 1.1,
            type: "melee",
            tier: 1,
            imgWidth: 65,
            imgHeight: 65,
          },
          {
            id: "u3_s",
            name: "Archer",
            ru: "–õ—É—á–Ω–∏–∫",
            cost: 75,
            hp: 76,
            atk: 28,
            spd: 0.55,
            atkSpeed: 2.4,
            type: "shoot",
            range: 300,
            bulletSpeed: 420,
            bulletSize: 20,
            bulletSprite: {
              player: {
                src: "images/medievalBullet.svg",
                width: 30,
                height: 30,
              },
              enemy: {
                src: "images/medievalBulletE.svg",
                width: 30,
                height: 30,
              },
            },
            tier: 2,
            imgWidth: 70,
            imgHeight: 70,
          },
          {
            id: "u3_h",
            name: "Cavalry",
            ru: "–í—Å–∞–¥–Ω–∏–∫",
            cost: 130,
            hp: 350,
            atk: 48,
            spd: 0.48,
            atkSpeed: 1.7,
            type: "melee",
            tier: 3,
            imgWidth: 75,
            imgHeight: 75,
          },
        ],
        4: [
          {
            id: "u4_m",
            name: "Line",
            ru: "–õ–∏–Ω–µ–π–Ω—ã–π",
            cost: 80,
            hp: 200,
            atk: 36,
            spd: 0.5,
            atkSpeed: 1.1,
            type: "melee",
            tier: 1,
            imgWidth: 75,
            imgHeight: 75,
          },
          {
            id: "u4_s",
            name: "Musketeer",
            ru: "–ú—É—à–∫–µ—Ç—ë—Ä",
            cost: 120,
            hp: 98,
            atk: 45,
            spd: 0.5,
            atkSpeed: 2,
            type: "shoot",
            range: 350,
            bulletSpeed: 440,
            bulletSize: 20,
            bulletSprite: {
              player: {
                src: "images/enlightenmentBullet.svg",
                width: 5,
                height: 5,
              },
              enemy: {
                src: "images/enlightenmentBullet.svg",
                width: 5,
                height: 5,
              },
            },
            tier: 2,
            imgWidth: 75,
            imgHeight: 75,
          },
          {
            id: "u4_h",
            name: "Dragoon",
            ru: "–î—Ä–∞–≥—É–Ω",
            cost: 210,
            hp: 600,
            atk: 110,
            spd: 0.43,
            atkSpeed: 2.0,
            type: "melee",
            tier: 3,
            imgWidth: 80,
            imgHeight: 80,
          },
        ],
        5: [
          {
            id: "u5_m",
            name: "Rifle",
            ru: "–†—É–∂–µ–π–Ω–∏–∫",
            cost: 110,
            hp: 320,
            atk: 46,
            spd: 0.5,
            atkSpeed: 1.0,
            type: "melee",
            tier: 1,
            imgWidth: 65,
            imgHeight: 65,
          },
          {
            id: "u5_s",
            name: "Gunner",
            ru: "–ü—É–ª–µ–º—ë—Ç—á–∏–∫",
            cost: 200,
            hp: 200,
            atk: 50,
            spd: 0.36,
            atkSpeed: 1.5,
            type: "shoot",
            range: 400,
            bulletSpeed: 520,
            bulletSize: 20,
            bulletSprite: {
              player: { src: "images/modernBullet.svg", width: 5, height: 5 },
              enemy: { src: "images/modernBullet.svg", width: 5, height: 5 },
            },
            tier: 2,
            imgWidth: 65,
            imgHeight: 65,
          },
          {
            id: "u5_h",
            name: "Tank",
            ru: "–¢–∞–Ω–∫",
            cost: 450,
            hp: 1600,
            atk: 220,
            spd: 0.2,
            atkSpeed: 2.6,
            type: "melee",
            tier: 3,
            imgWidth: 120,
            imgHeight: 130,
            unitType: "tank",
          },
        ],
        6: [
          {
            id: "u6_m",
            name: "Jedi",
            ru: "–î–∂–µ–¥–∞–π",
            cost: 175,
            hp: 420,
            atk: 80,
            spd: 0.75,
            atkSpeed: 1.0,
            type: "melee",
            tier: 1,
            imgWidth: 65,
            imgHeight: 65,
          },
          {
            id: "u6_s",
            name: "Drone",
            ru: "–î—Ä–æ–Ω",
            cost: 350,
            hp: 360,
            atk: 180,
            spd: 0.37,
            atkSpeed: 2,
            type: "shoot",
            range: 450,
            bulletSpeed: 620,
            bulletSize: 20,
            bulletSprite: {
              player: { src: "images/futureBullet.svg", width: 15, height: 15 },
              enemy: { src: "images/futureBullet.svg", width: 15, height: 15 },
            },
            tier: 2,
            imgWidth: 60,
            imgHeight: 60,
          },
          {
            id: "u6_h",
            name: "Mech",
            ru: "–ú–µ—Ö",
            cost: 750,
            hp: 3000,
            atk: 420,
            spd: 0.32,
            atkSpeed: 2.8,
            type: "melee",
            tier: 3,
            imgWidth: 80,
            imgHeight: 80,
          },
        ],
      };

      const DIFF = {
        easy: {
          enemySpawnRate: 3.7,
          bossMul: 0.9,
          incomeMultiplier: 0.8,
          enemyAgeUpgradeSpeed: 0.8,
        },
        medium: {
          enemySpawnRate: 2.6,
          bossMul: 1.0,
          incomeMultiplier: 1.0,
          enemyAgeUpgradeSpeed: 1.05,
        },
        hard: {
          enemySpawnRate: 1.7,
          bossMul: 1.25,
          incomeMultiplier: 1.2,
          enemyAgeUpgradeSpeed: 1.25,
        },
      };

      const XP_REQUIRED = [200, 400, 800, 1600, 3000];

      const I18N = {
        en: {
          title: "War through the Ages",
          normal: "Normal",
          bosses: "Bosses",
          settings: "Settings",
          startNormal: "Start",
          startBoss: "Start",
          chooseBossLocked: "Choose an unlocked boss",
          insufficientGold: "Not enough gold",
          notEnoughXP: "Not enough XP",
          enemyBaseDestroyed: "Enemy base destroyed!",
          bossDefeated: "Boss defeated ‚Äî You win!",
          hackLocked: "Hack locked: beat all bosses",
          unlockedBoss: "Unlocked boss: ",
          paused: "Paused",
          resume: "Resume",
          returnMenu: "Return to Menu",
          victoryBoss: "Victory ‚Äî Boss defeated",
          victoryBase: "Victory ‚Äî enemy base destroyed (no boss)",
          defeatBase: "Defeat ‚Äî your base destroyed",
          resetConfirm: "Reset progression?",
          progressReset: "Progress reset",
          killMsg: "Killed: ",
          withoutBoss: "Without boss",
          difficulty: "Difficulty: ",
          infiniteGold: "Infinite Gold",
          infiniteXP: "Infinite XP",
          pauseTime: "Pause Time",
          killEnemyUnits: "Kill All Enemy Units",
          killPlayerUnits: "Kill All Your Units",
          enemyNoSpawn: "Enemy doesn't spawn",
          hack: "Hack",
          menu: "Menu",
          upgradeAge: "Upgrade Age",
          gold: "Gold",
          xp: "XP",
          age: "Age",
          you: "YOU",
          enemy: "ENEMY",
          resumeGame: "Resume Game",
          restart: "Restart",
          toMenu: "To Menu",
          victory: "Victory",
          defeat: "Defeat",
          pleaseRotate: "Please rotate your device to landscape mode",
          rotateMessage:
            "This game works best in landscape orientation on mobile devices",
          easy: "Easy",
          medium: "Medium",
          hard: "Hard",
          language: "Language",
          volume: "Volume",
          unlocked: "Unlocked",
          locked: "Locked",
        },
        ru: {
          title: "–í–æ–π–Ω–∞ —Å–∫–≤–æ–∑—å –≤–µ–∫–∞",
          normal: "–û–±—ã—á–Ω—ã–π",
          bosses: "–ë–æ—Å—Å—ã",
          settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
          startNormal: "–ù–∞—á–∞—Ç—å",
          startBoss: "–ù–∞—á–∞—Ç—å",
          chooseBossLocked: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –±–æ—Å—Å–∞",
          insufficientGold: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞",
          notEnoughXP: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ XP",
          enemyBaseDestroyed: "–ë–∞–∑–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞!",
          bossDefeated: "–ë–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω ‚Äî –≤—ã –ø–æ–±–µ–∂–¥–∞–µ—Ç–µ!",
          hackLocked: "–•–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø–æ–±–µ–¥–∏—Ç–µ –≤—Å–µ—Ö –±–æ—Å—Å–æ–≤",
          unlockedBoss: "–û—Ç–∫—Ä—ã—Ç –±–æ—Å—Å: ",
          paused: "–ü–∞—É–∑–∞",
          resume: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
          returnMenu: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é",
          victoryBoss: "–ü–æ–±–µ–¥–∞ ‚Äî –±–æ—Å—Å –ø–æ–≤–µ—Ä–∂–µ–Ω",
          victoryBase: "–ü–æ–±–µ–¥–∞ ‚Äî –±–∞–∑–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞ (–±–µ–∑ –±–æ—Å—Å–∞)",
          defeatBase: "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –±–∞–∑–∞ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞",
          resetConfirm: "–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?",
          progressReset: "–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω",
          killMsg: "–£–±–∏—Ç: ",
          withoutBoss: "–ë–µ–∑ –±–æ—Å—Å–∞",
          difficulty: "–°–ª–æ–∂–Ω–æ—Å—Ç—å: ",
          infiniteGold: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –∑–æ–ª–æ—Ç–æ",
          infiniteXP: "–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π XP",
          pauseTime: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è",
          killEnemyUnits: "–£–±–∏—Ç—å –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤",
          killPlayerUnits: "–£–±–∏—Ç—å –≤—Å–µ—Ö —Å–≤–æ–∏—Ö",
          enemyNoSpawn: "–í—Ä–∞–≥–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è",
          hack: "–•–∞–∫",
          menu: "–ú–µ–Ω—é",
          upgradeAge: "–£–ª—É—á—à–∏—Ç—å —ç–ø–æ—Ö—É",
          gold: "–ó–æ–ª–æ—Ç–æ",
          xp: "–û–ø—ã—Ç",
          age: "–≠–ø–æ—Ö–∞",
          you: "–í–´",
          enemy: "–í–†–ê–ì",
          resumeGame: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
          restart: "–ó–∞–Ω–æ–≤–æ",
          toMenu: "–í –º–µ–Ω—é",
          victory: "–ü–æ–±–µ–¥–∞",
          defeat: "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ",
          pleaseRotate:
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –∞–ª—å–±–æ–º–Ω—ã–π (–≥–æ—Ä–∏–∑–æ–Ω–∞–ª—å–Ω—ã–π) —Ä–µ–∂–∏–º",
          rotateMessage:
            "–≠—Ç–∞ –∏–≥—Ä–∞ –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∞–ª—å–±–æ–º–Ω–æ–π (–≥–æ—Ä–∏–∑–æ–Ω–∞–ª—å–Ω–æ–π) –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö",
          easy: "–õ–µ–≥–∫–∞—è",
          medium: "–°—Ä–µ–¥–Ω—è—è",
          hard: "–°–ª–æ–∂–Ω–∞—è",
          language: "–Ø–∑—ã–∫",
          volume: "–ì—Ä–æ–º–∫–æ—Å—Ç—å",
          unlocked: "–û—Ç–∫—Ä—ã—Ç",
          locked: "–ó–∞–∫—Ä—ã—Ç",
        },
      };

      // Game state
      let state = {
        mode: null,
        difficulty: "medium",
        chosenBossId: 1,
        bossChoice: null,
        running: false,
        gold: 110,
        xp: 0,
        playerAge: 1,
        enemyAge: 1,
        playerBaseHP: HP_PER_AGE[0],
        enemyBaseHP: HP_PER_AGE[0],
        units: [],
        projectiles: [],
        time: 0,
        enemySpawnTimer: 0,
        bossActive: false,
        bossHP: 0,
        bossDefeated: false,
        enemyBaseDestroyed: false,
        enemyAgeUpgradeCooldown: 45,
        infiniteGold: false,
        infiniteXP: false,
        timeMultiplier: 1,
        volume: 0.8,
        unlocked: JSON.parse(localStorage.getItem("aow_unlocked") || "[1]"),
        lang:
          localStorage.getItem("aow_lang") ||
          (navigator.language && navigator.language.startsWith("ru")
            ? "ru"
            : "en"),
        showHPNumbers: false,
        hackEnabled: false,
        timePaused: false,
        stopEnemySpawn: false,
        currentMusic: null,
        audioEnabled: false,
        menuUnits: [],
        futureCompleted: false, // NEW: Track if Future era has been completed
      };

      // DOM elements
      const $ = (id) => document.getElementById(id);
      const menu = $("menu"),
        panelNormal = $("panelNormal"),
        panelBosses = $("panelBosses"),
        panelSettings = $("panelSettings");
      const btnNormal = $("btnNormal"),
        btnBosses = $("btnBosses"),
        btnSettings = $("btnSettings");
      const startNormal = $("startNormal"),
        startBoss = $("startBoss");
      const bossListEl = $("bossList");
      const volRange = $("vol");
      const topLeft = $("topLeft"),
        topMid = $("topMid"),
        topAge = $("topAge");
      const battleUnits = $("battleUnits"),
        battleEl = $("battle"),
        pHP = $("pHP"),
        eHP = $("eHP");
      const goldEl = $("gold"),
        xpEl = $("xp"),
        ageText = $("ageText");
      const unitButtons = $("unitButtons"),
        upgradeAge = $("upgradeAge"),
        ageCost = $("ageCost");
      const speedBtns = document.querySelectorAll(".speedBtn");
      const hackBtn = $("hackBtn"),
        hackPopup = $("hackPopup"),
        infGold = $("infGold"),
        infXP = $("infXP"),
        pauseTimeBtn = $("pauseTimeBtn"),
        killEnemyBtn = $("killEnemyBtn"),
        killPlayerBtn = $("killPlayerBtn"),
        stopEnemySpawn = $("stopEnemySpawn");
      const menuBtn = $("menuBtn");
      const pauseModal = $("pauseModal"),
        pauseCancel = $("pauseCancel"),
        pauseMenu = $("pauseMenu"),
        pauseTitle = $("pauseTitle");
      const finishOverlay = $("finishOverlay"),
        finishTitle = $("finishTitle"),
        finishMessage = $("finishMessage"),
        finishRestart = $("finishRestart"),
        finishToMenu = $("finishToMenu");
      const orientationWarning = $("orientationWarning");
      const mainMusic = $("mainMusic"),
        bossMusic = $("bossMusic"),
        ancientMusic = $("ancientMusic"),
        antiquityMusic = $("antiquityMusic"),
        medievalMusic = $("medievalMusic"),
        enlightenmentMusic = $("enlightenmentMusic"),
        modernMusic = $("modernMusic"),
        futureMusic = $("futureMusic"),
        menuMusic = $("menuMusic");

      // Helper functions
      function L(key) {
        return I18N[state.lang][key] || key;
      }

      function enableAudio() {
        state.audioEnabled = true;
        const allMusic = [
          mainMusic,
          bossMusic,
          ancientMusic,
          antiquityMusic,
          medievalMusic,
          enlightenmentMusic,
          modernMusic,
          futureMusic,
          menuMusic,
        ];
        allMusic.forEach((music) => {
          if (music) music.volume = state.volume;
        });
        playMenuMusic();
      }

      function playMenuMusic() {
        if (!state.audioEnabled || state.currentMusic === "menu") return;
        stopAllMusic();
        if (!window.audioContext)
          window.audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        if (window.audioContext.state === "suspended")
          window.audioContext.resume();
        const menuMusicOptions = [
          ancientMusic,
          antiquityMusic,
          medievalMusic,
          enlightenmentMusic,
          modernMusic,
          futureMusic,
          mainMusic,
          menuMusic,
        ].filter((music) => music !== null);
        if (menuMusicOptions.length > 0) {
          const randomMusic =
            menuMusicOptions[
              Math.floor(Math.random() * menuMusicOptions.length)
            ];
          randomMusic.volume = state.volume;
          randomMusic.loop = true;
          const playPromise = randomMusic.play();
          if (playPromise !== undefined)
            playPromise
              .then(() => {
                state.currentMusic = "menu";
              })
              .catch(() => {
                state.currentMusic = null;
              });
        }
      }

      function playAgeMusic(age) {
        if (!state.audioEnabled || state.currentMusic === age) return;
        stopAllMusic();
        let musicElement;
        switch (age) {
          case 1:
            musicElement = ancientMusic;
            break;
          case 2:
            musicElement = antiquityMusic;
            break;
          case 3:
            musicElement = medievalMusic;
            break;
          case 4:
            musicElement = enlightenmentMusic;
            break;
          case 5:
            musicElement = modernMusic;
            break;
          case 6:
            musicElement = futureMusic;
            break;
          default:
            musicElement = mainMusic;
        }
        if (musicElement) {
          musicElement.volume = state.volume;
          musicElement
            .play()
            .then(() => {
              state.currentMusic = age;
            })
            .catch(() => {});
        }
      }

      function playBossMusic() {
        if (!state.audioEnabled || state.currentMusic === "boss") return;
        stopAllMusic();
        if (bossMusic) {
          bossMusic.volume = state.volume;
          bossMusic
            .play()
            .then(() => {
              state.currentMusic = "boss";
            })
            .catch(() => {});
        }
      }

      function stopAllMusic() {
        const allMusic = [
          mainMusic,
          bossMusic,
          ancientMusic,
          antiquityMusic,
          medievalMusic,
          enlightenmentMusic,
          modernMusic,
          futureMusic,
          menuMusic,
        ];
        allMusic.forEach((music) => {
          if (music) {
            music.pause();
            music.currentTime = 0;
          }
        });
        state.currentMusic = null;
      }

      function beep(freq = 440, dur = 0.06) {
        if (!state.audioEnabled) return;
        try {
          if (!window.audioCtx)
            window.audioCtx = new (window.AudioContext ||
              window.webkitAudioContext)();
          const g = window.audioCtx.createGain();
          g.gain.value = state.volume;
          g.connect(window.audioCtx.destination);
          const o = window.audioCtx.createOscillator();
          o.type = "sine";
          o.frequency.value = freq;
          o.connect(g);
          o.start();
          setTimeout(() => {
            o.stop();
            g.disconnect();
          }, dur * 1000);
        } catch (e) {}
      }

      function saveLang() {
        localStorage.setItem("aow_lang", state.lang);
      }
      function saveUnlocked() {
        localStorage.setItem("aow_unlocked", JSON.stringify(state.unlocked));
      }

      function showToast(text, t = 1400) {
        const el = document.createElement("div");
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.transform = "translateX(-50%)";
        el.style.bottom = "12%";
        el.style.background = "rgba(0,0,0,0.7)";
        el.style.padding = "8px 12px";
        el.style.borderRadius = "8px";
        el.style.zIndex = 9999;
        el.textContent = text;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), t);
      }

      // Mobile UI functions
      function updateMobileUI() {
        const mobileGold = document.getElementById("mobileGold");
        const mobileXP = document.getElementById("mobileXP");
        const mobileAge = document.getElementById("mobileAge");
        const mobileAgeCost = document.getElementById("mobileAgeCost");
        const mobileBossInfo = document.getElementById("mobileBossInfo");

        if (mobileGold) {
          mobileGold.textContent = state.infiniteGold
            ? "‚àû"
            : Math.floor(state.gold);
        }
        if (mobileXP) {
          mobileXP.textContent = state.infiniteXP ? "‚àû" : Math.floor(state.xp);
        }
        if (mobileAge) {
          const ageName =
            state.lang === "ru"
              ? AGES[state.playerAge - 1].ru
              : AGES[state.playerAge - 1].name;
          mobileAge.textContent =
            ageName.length > 8 ? ageName.substring(0, 8) + "..." : ageName;
        }
        if (mobileAgeCost) {
          const cost = XP_REQUIRED[state.playerAge - 1] || 9999;
          const currentXP = state.infiniteXP ? "‚àû" : Math.floor(state.xp);
          mobileAgeCost.textContent = `${currentXP}/${cost}`;
        }
        if (mobileBossInfo) {
          if (state.mode === "boss" && state.bossChoice && state.bossActive) {
            mobileBossInfo.textContent =
              (state.lang === "ru"
                ? state.bossChoice.ru
                : state.bossChoice.name) +
              " ‚Ä¢ " +
              (state.lang === "ru" ? "–≠–ø–æ—Ö–∞: " : "Age: ") +
              (state.lang === "ru"
                ? AGES[state.bossChoice.age - 1].ru
                : AGES[state.bossChoice.age - 1].name);
          } else {
            const diffText =
              state.lang === "ru"
                ? state.difficulty === "easy"
                  ? "–õ–µ–≥–∫–∞—è"
                  : state.difficulty === "medium"
                  ? "–°—Ä–µ–¥–Ω—è—è"
                  : "–°–ª–æ–∂–Ω–∞—è"
                : state.difficulty;
            mobileBossInfo.textContent =
              (state.mode === "none"
                ? L("withoutBoss")
                : state.bossChoice
                ? state.lang === "ru"
                  ? state.bossChoice.ru
                  : state.bossChoice.name
                : L("withoutBoss")) +
              " ‚Ä¢ " +
              L("difficulty") +
              diffText +
              " ‚Ä¢ " +
              (state.lang === "ru" ? "–≠–ø–æ—Ö–∞ –≤—Ä–∞–≥–∞: " : "Enemy age: ") +
              (state.lang === "ru"
                ? AGES[state.enemyAge - 1].ru
                : AGES[state.enemyAge - 1].name);
          }
        }
      }

      function buildMobileUnitButtons() {
        const mobileUnitButtons = document.getElementById("mobileUnitButtons");
        if (!mobileUnitButtons) return;

        mobileUnitButtons.innerHTML = "";
        const list = UNIT_TEMPLATES[state.playerAge] || [];
        const costMultiplier = 1 + (state.playerAge - 1) * 0.18;

        list.forEach((t) => {
          const b = document.createElement("div");
          b.className = "mobile-unit-btn";
          const displayCost = Math.round(t.cost * costMultiplier);

          const unitName = document.createElement("div");
          unitName.className = "unit-name";
          unitName.textContent = state.lang === "ru" && t.ru ? t.ru : t.name;

          const unitCost = document.createElement("div");
          unitCost.className = "unit-cost";
          unitCost.textContent = "$" + displayCost;

          b.appendChild(unitName);
          b.appendChild(unitCost);

          b.onclick = () => spawnUnit("player", t);
          mobileUnitButtons.appendChild(b);
        });
      }

      function initializeMobileControls() {
        // Mobile upgrade button
        const mobileUpgradeAge = document.getElementById("mobileUpgradeAge");
        if (mobileUpgradeAge) {
          mobileUpgradeAge.onclick = () => {
            if (state.playerAge >= AGES.length) {
              showToast(
                state.lang === "ru"
                  ? "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–ø–æ—Ö–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!"
                  : "Maximum age reached!"
              );
              return;
            }
            const cost = XP_REQUIRED[state.playerAge - 1] || 9999;
            if (state.infiniteXP || state.xp >= cost) {
              if (!state.infiniteXP) state.xp -= cost;
              state.playerAge++;
              state.playerBaseHP = HP_PER_AGE[state.playerAge - 1];
              buildUnitButtons();
              buildMobileUnitButtons();
              playAgeMusic(state.playerAge);
              updateUI();
              updateMobileUI();
              showToast(
                (state.lang === "ru" ? "–ü–µ—Ä–µ—Ö–æ–¥ –≤ —ç–ø–æ—Ö—É: " : "Upgraded to ") +
                  (state.lang === "ru"
                    ? AGES[state.playerAge - 1].ru
                    : AGES[state.playerAge - 1].name)
              );
              if (state.playerAge >= AGES.length) {
                upgradeAge.style.display = "none";
                if (mobileUpgradeAge) mobileUpgradeAge.style.display = "none";
                showToast(
                  state.lang === "ru"
                    ? "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–µ–¥–µ–ª –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!"
                    : "Technological limit reached!"
                );
              }
            } else {
              showToast(L("notEnoughXP"));
            }
          };
        }

        // Mobile speed buttons
        const mobileSpeedBtns = document.querySelectorAll(".mobile-speed-btn");
        mobileSpeedBtns.forEach((btn) => {
          btn.onclick = () => {
            state.timeMultiplier = parseFloat(btn.dataset.speed);
            document
              .querySelectorAll(".mobile-speed-btn")
              .forEach((x) => x.classList.remove("active"));
            document
              .querySelectorAll(".speedBtn")
              .forEach((x) => x.classList.remove("active"));
            btn.classList.add("active");
            document
              .querySelector(`.speedBtn[data-speed="${btn.dataset.speed}"]`)
              .classList.add("active");
            showToast("x" + btn.dataset.speed, 700);
          };
        });

        // Mobile menu button
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        if (mobileMenuBtn) {
          mobileMenuBtn.onclick = () => {
            pauseTitle.textContent = L("paused");
            pauseModal.style.display = "flex";
            pauseModal._wasRunning = state.running;
            state.running = false;
          };
        }

        // Mobile hack button
        const mobileHackBtn = document.getElementById("mobileHackBtn");
        if (mobileHackBtn) {
          mobileHackBtn.onclick = () => {
            if (!state.hackEnabled) {
              showToast(state.lang === "ru" ? "–•–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" : "Hack locked");
              return;
            }
            hackPopup.style.display =
              hackPopup.style.display === "flex" ? "none" : "flex";
          };
        }
      }

      // Game initialization
      function createMenuBackground() {
        const menuBackground = document.createElement("div");
        menuBackground.id = "menuBackground";
        document.body.appendChild(menuBackground);
        spawnMenuUnits();
      }

      function spawnMenuUnits() {
        updateUI();
        if (!state.running && document.getElementById("menuBackground")) {
          const allUnits = [];
          for (let age = 1; age <= 6; age++) {
            const ageUnits = UNIT_TEMPLATES[age] || [];
            ageUnits.forEach((unit) => allUnits.push(unit));
          }
          const unitTemplate =
            allUnits[Math.floor(Math.random() * allUnits.length)];
          const unitEl = document.createElement("div");
          unitEl.className = "menu-unit";
          const img = document.createElement("img");
          img.src = `images/${unitTemplate.name.toLowerCase()}.svg`;
          img.alt = unitTemplate.name;
          unitEl.appendChild(img);
          const size = 80 + Math.random() * 70;
          unitEl.style.width = `${size}px`;
          unitEl.style.height = `${size}px`;
          unitEl.style.left = `-${size}px`;
          unitEl.style.top = `${10 + Math.random() * 80}%`;
          document.getElementById("menuBackground").appendChild(unitEl);
          const duration = 15 + Math.random() * 25;
          unitEl.style.transition = `left ${duration}s linear`;
          setTimeout(() => {
            unitEl.style.left = "100%";
          }, 10);
          setTimeout(() => {
            if (unitEl.parentNode) unitEl.parentNode.removeChild(unitEl);
          }, duration * 1000 + 10);
          state.menuUnits.push(unitEl);
          const nextSpawn = 500 + Math.random() * 2000;
          setTimeout(spawnMenuUnits, nextSpawn);
        }
      }

      function clearMenuBackground() {
        state.menuUnits.forEach((unit) => {
          if (unit.parentNode) unit.parentNode.removeChild(unit);
        });
        state.menuUnits = [];
        const menuBackground = document.getElementById("menuBackground");
        if (menuBackground)
          menuBackground.parentNode.removeChild(menuBackground);
      }

      function initializeLanguageSwitcher() {
        const langOptions = document.querySelectorAll(".lang-option");
        langOptions.forEach((option) => {
          option.classList.remove("active");
        });
        langOptions.forEach((option) => {
          if (option.dataset.lang === state.lang)
            option.classList.add("active");
          option.onclick = () => {
            document.querySelectorAll(".lang-option").forEach((opt) => {
              opt.classList.remove("active");
            });
            option.classList.add("active");
            state.lang = option.dataset.lang;
            saveLang();
            buildBossList();
            updateTop();
            buildUnitButtons();
            buildMobileUnitButtons();
            updateUI();
            localizeText();
            showToast(
              state.lang === "ru"
                ? "–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ –†—É—Å—Å–∫–∏–π"
                : "Language changed to English",
              1500
            );
          };
        });
      }

      function initializeHackMenu() {
        if (!hackBtn || !hackPopup) return;
        hackBtn.onclick = () => {
          if (!state.hackEnabled) {
            showToast(state.lang === "ru" ? "–•–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" : "Hack locked");
            return;
          }
          hackPopup.style.display =
            hackPopup.style.display === "flex" ? "none" : "flex";
        };
        if (infGold)
          infGold.onchange = () => {
            state.infiniteGold = infGold.checked;
            showToast(state.infiniteGold ? "Infinite Gold" : "Gold normal");
          };
        if (infXP)
          infXP.onchange = () => {
            state.infiniteXP = infXP.checked;
            showToast(state.infiniteXP ? "Infinite XP" : "XP normal");
          };
        if (stopEnemySpawn)
          stopEnemySpawn.onchange = () => {
            state.stopEnemySpawn = stopEnemySpawn.checked;
            showToast(
              state.stopEnemySpawn
                ? "Enemy spawn stopped"
                : "Enemy spawn enabled"
            );
          };
        if (pauseTimeBtn)
          pauseTimeBtn.onclick = () => {
            state.timePaused = !state.timePaused;
            pauseTimeBtn.textContent = state.timePaused
              ? "Continue"
              : "Pause Time";
            showToast(state.timePaused ? "Time Paused" : "Time Resumed");
          };
        if (killEnemyBtn)
          killEnemyBtn.onclick = () => {
            for (let i = state.units.length - 1; i >= 0; i--) {
              if (state.units[i].side === "enemy") {
                try {
                  state.units[i].el.remove();
                } catch (e) {}
                state.units.splice(i, 1);
              }
            }
            showToast("All enemy units killed");
          };
        if (killPlayerBtn)
          killPlayerBtn.onclick = () => {
            for (let i = state.units.length - 1; i >= 0; i--) {
              if (state.units[i].side === "player") {
                try {
                  state.units[i].el.remove();
                } catch (e) {}
                state.units.splice(i, 1);
              }
            }
            showToast("All player units killed");
          };
      }

      function initializeSpeedButtons() {
        speedBtns.forEach((btn) => {
          btn.onclick = () => {
            state.timeMultiplier = parseFloat(btn.dataset.speed);
            document
              .querySelectorAll(".speedBtn")
              .forEach((x) => x.classList.remove("active"));
            btn.classList.add("active");
            showToast("x" + btn.dataset.speed, 700);
          };
        });
      }

      function initializeMenuButton() {
        if (menuBtn) {
          menuBtn.onclick = () => {
            pauseTitle.textContent = L("paused");
            pauseModal.style.display = "flex";
            pauseModal._wasRunning = state.running;
            state.running = false;
          };
        }
      }

      // Add double click functionality to boss selection
      function initializeBossDoubleClick() {
        const bossItems = document.querySelectorAll(".boss-item");
        let clickTimer = null;

        bossItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            if (clickTimer === null) {
              clickTimer = setTimeout(() => {
                // Single click behavior
                const bossId = this.getAttribute("data-boss-id");
                if (bossId) {
                  state.chosenBossId = parseInt(bossId);
                  state.bossChoice = BOSSES.find(
                    (b) => b.id === state.chosenBossId
                  );
                  highlightSelected();
                  updateTop();
                }
                clickTimer = null;
              }, 300);
            } else {
              clearTimeout(clickTimer);
              clickTimer = null;

              // Double click behavior - start game
              this.classList.add("boss-double-click");
              setTimeout(() => this.classList.remove("boss-double-click"), 600);

              const bossId = this.getAttribute("data-boss-id");
              if (bossId) {
                const boss = BOSSES.find((b) => b.id === parseInt(bossId));
                if (boss && state.unlocked.includes(boss.id)) {
                  state.chosenBossId = boss.id;
                  state.bossChoice = boss;
                  startBossGame();
                } else {
                  showToast(
                    state.lang === "ru" ? "–ë–æ—Å—Å –∑–∞–∫—Ä—ã—Ç" : "Boss locked"
                  );
                }
              }
            }
          });
        });
      }

      function buildBossList() {
        if (!bossListEl) return;
        bossListEl.innerHTML = "";
        BOSSES.forEach((b, i) => {
          const unlocked = state.unlocked.includes(b.id);
          const row = document.createElement("div");
          row.className =
            "boss-item" + (state.chosenBossId === b.id ? " selected" : "");
          row.setAttribute("data-boss-id", b.id);
          if (!unlocked) row.classList.add("locked");

          // Single click for selection
          row.onclick = null; // We'll handle via the double click system

          const bossInfo = document.createElement("div");
          bossInfo.className = "boss-info";

          const bossName = document.createElement("div");
          bossName.className = "boss-name";
          bossName.textContent = state.lang === "ru" ? b.ru : b.name;

          const bossAge = document.createElement("div");
          bossAge.className = "boss-age";
          bossAge.textContent =
            state.lang === "ru" ? AGES[b.age - 1].ru : AGES[b.age - 1].name;

          bossInfo.appendChild(bossName);
          bossInfo.appendChild(bossAge);

          const bossStatus = document.createElement("div");
          bossStatus.className = "boss-status";
          bossStatus.textContent = unlocked ? L("unlocked") : L("locked");

          row.appendChild(bossInfo);
          row.appendChild(bossStatus);
          bossListEl.appendChild(row);
        });
        highlightSelected();
        initializeBossDoubleClick();
      }

      function highlightSelected() {
        if (!bossListEl) return;
        Array.from(bossListEl.children).forEach((el, i) => {
          const boss = BOSSES[i];
          if (boss && boss.id === state.chosenBossId)
            el.classList.add("selected");
          else el.classList.remove("selected");
        });
      }

      function updateTop() {
        if (!topLeft || !topMid || !topAge) return;
        if (state.mode === "boss" && state.bossChoice && state.bossActive) {
          topLeft.textContent =
            state.lang === "ru" ? state.bossChoice.ru : state.bossChoice.name;
          topMid.textContent = "";
          topAge.textContent =
            (state.lang === "ru" ? "–≠–ø–æ—Ö–∞ –≤—Ä–∞–≥–∞: " : "Enemy age: ") +
            (state.lang === "ru"
              ? AGES[state.bossChoice.age - 1].ru
              : AGES[state.bossChoice.age - 1].name);
        } else {
          topLeft.textContent =
            state.mode === "none"
              ? L("withoutBoss")
              : state.bossChoice
              ? state.lang === "ru"
                ? state.bossChoice.ru
                : state.bossChoice.name
              : L("withoutBoss");
          const diffText =
            state.lang === "ru"
              ? state.difficulty === "easy"
                ? "–õ–µ–≥–∫–∞—è"
                : state.difficulty === "medium"
                ? "–°—Ä–µ–¥–Ω—è—è"
                : "–°–ª–æ–∂–Ω–∞—è"
              : state.difficulty;
          topMid.textContent =
            (state.mode === "boss" ? "" : L("difficulty")) +
            (state.mode === "boss" ? "" : diffText);
          topAge.textContent =
            (state.lang === "ru" ? "–≠–ø–æ—Ö–∞ –≤—Ä–∞–≥–∞: " : "Enemy age: ") +
            (state.lang === "ru"
              ? AGES[state.enemyAge - 1].ru
              : AGES[state.enemyAge - 1].name);
        }
      }

      function buildUnitButtons() {
        if (!unitButtons) return;
        unitButtons.innerHTML = "";
        const list = UNIT_TEMPLATES[state.playerAge] || [];
        const costMultiplier = 1 + (state.playerAge - 1) * 0.18;
        list.forEach((t) => {
          const b = document.createElement("div");
          b.className = "unit-btn";
          const displayCost = Math.round(t.cost * costMultiplier);
          const unitName = document.createElement("div");
          unitName.className = "unit-name";
          unitName.textContent = state.lang === "ru" && t.ru ? t.ru : t.name;
          const unitCost = document.createElement("div");
          unitCost.className = "unit-cost";
          unitCost.textContent = "$" + displayCost;
          b.appendChild(unitName);
          b.appendChild(unitCost);
          b.onclick = () => spawnUnit("player", t);
          unitButtons.appendChild(b);
        });
        checkUnitButtonsFit();
      }

      function checkUnitButtonsFit() {
        if (!unitButtons) return;
        const buttons = unitButtons.querySelectorAll(".unit-btn");
        let totalWidth = 0;
        buttons.forEach((btn) => {
          totalWidth += btn.offsetWidth + 8;
        });
        totalWidth += 16;
        if (totalWidth <= unitButtons.offsetWidth)
          unitButtons.classList.add("no-scroll");
        else unitButtons.classList.remove("no-scroll");
      }

      function spawnUnit(side, template) {
        updateUI();
        if (side === "player") {
          const costMultiplier = 1 + (state.playerAge - 1) * 0.18;
          const effectiveCost = Math.round(
            (template.cost || 0) * costMultiplier
          );
          if (!state.infiniteGold && state.gold < effectiveCost) {
            showToast(L("insufficientGold"));
            return;
          }
          if (!state.infiniteGold) state.gold -= effectiveCost;
          updateUI();
        }
        const battleRect = battleEl.getBoundingClientRect();
        const el = document.createElement("div");
        el.className = "unit " + (side === "player" ? "player" : "enemy");
        el.style.width = (template.imgWidth || 60) + "px";
        el.style.height = (template.imgHeight || 60) + "px";
        if (template.unitType === "tank")
          el.setAttribute("data-unit-type", "tank");
        const img = document.createElement("img");
        const imageName = template.name.toLowerCase();
        img.src = `images/${imageName}${side === "enemy" ? "E" : ""}.svg`;
        img.alt = template.name;
        el.appendChild(img);
        const hpBar = document.createElement("div");
        hpBar.className = "hpBar";
        const hpFill = document.createElement("div");
        hpFill.className = "hpFill";
        hpBar.appendChild(hpFill);
        el.appendChild(hpBar);
        if (battleUnits) battleUnits.appendChild(el);
        const startX = side === "player" ? 100 : battleRect.width - 160;
        const unitHP = template.hp || 60;
        const u = {
          id: Math.random().toString(36).slice(2, 9),
          template,
          side,
          hp: unitHP,
          maxHp: unitHP,
          atk: template.atk,
          spd: template.spd,
          x: startX,
          width: template.imgWidth || 60,
          el,
          atkTimer: 0,
          atkSpeed: template.atkSpeed || 1.0,
          isBoss: false,
          age: side === "player" ? state.playerAge : state.enemyAge,
          attackingBase: false,
          target: null,
        };
        state.units.push(u);
        renderAll();
      }

      function createProjectile(fromUnit, target) {
        const br = battleEl.getBoundingClientRect();
        const startX =
          fromUnit.x + (fromUnit.side === "player" ? fromUnit.width : -6);
        const el = document.createElement("div");
        el.className = "proj";
        el.style.width = (fromUnit.template.bulletSize || 20) + "px";
        el.style.height = (fromUnit.template.bulletSize || 20) + "px";
        el.style.left = startX + "px";
        el.style.bottom = fromUnit.isBoss ? "20%" : "18%";
        const img = document.createElement("img");
        const bulletSprite = fromUnit.template.bulletSprite;
        if (bulletSprite) {
          if (bulletSprite.player && bulletSprite.enemy)
            img.src =
              fromUnit.side === "player"
                ? bulletSprite.player.src
                : bulletSprite.enemy.src;
          else img.src = bulletSprite.src;
          img.alt = "bullet";
          el.appendChild(img);
        } else {
          el.style.background =
            fromUnit.side === "player" ? "#ffd27a" : "#ffd2d2";
          el.style.borderRadius = "50%";
        }
        if (battleUnits) battleUnits.appendChild(el);
        let targetRef = null;
        let targetX = null;
        if (typeof target === "object" && target !== null) {
          if (target.id === "BOSS") {
            targetRef = state.units.find((u) => u.isBoss) || null;
            targetX = targetRef
              ? targetRef.x
              : fromUnit.side === "player"
              ? br.width - 160
              : 140;
          } else {
            targetRef = target;
            targetX = targetRef.x;
          }
        } else if (typeof target === "number") targetX = target;
        else targetX = fromUnit.side === "player" ? br.width - 160 : 140;
        const proj = {
          el,
          x: startX,
          from: fromUnit.side,
          targetRef,
          targetX,
          speed: fromUnit.template.bulletSpeed || 420,
          dmg: Math.max(1, Math.round(fromUnit.atk * 0.92)),
          life: 3,
        };
        state.projectiles.push(proj);
      }

      function updateProjectiles(dt) {
        if (!state.projectiles.length) return;
        const br = battleEl.getBoundingClientRect();
        for (let i = state.projectiles.length - 1; i >= 0; i--) {
          const p = state.projectiles[i];
          p.life -= dt;
          if (p.targetRef) {
            const alive = state.units.find((u) => u === p.targetRef);
            if (
              !alive ||
              (p.targetRef.hp !== undefined && p.targetRef.hp <= 0)
            ) {
              p.targetRef = null;
              p.targetX = p.from === "player" ? br.width - 160 : 140;
            } else p.targetX = p.targetRef.x;
          }
          if (p.life <= 0) {
            try {
              p.el.remove();
            } catch (e) {}
            state.projectiles.splice(i, 1);
            continue;
          }
          const dir = p.targetX > p.x ? 1 : -1;
          p.x += dir * p.speed * dt;
          p.el.style.left = p.x + "px";
          let hit = false;
          for (const u of state.units) {
            if (u.side === p.from) continue;
            if (Math.abs(u.x - p.x) < 18) {
              if (u.isBoss) {
                state.bossHP -= p.dmg;
                const bo = state.units.find((z) => z.isBoss);
                if (bo) bo.hp = state.bossHP;
                if (state.bossHP <= 0) onBossDefeated();
              } else u.hp -= p.dmg;
              hit = true;
              break;
            }
          }
          if (!hit) {
            if (p.from === "player" && p.x >= br.width - 160) {
              if (state.bossActive) {
                state.bossHP -= p.dmg;
                const bo = state.units.find((z) => z.isBoss);
                if (bo) bo.hp = state.bossHP;
                if (state.bossHP <= 0) onBossDefeated();
              } else state.enemyBaseHP -= p.dmg;
              hit = true;
            } else if (p.from === "enemy" && p.x <= 140) {
              state.playerBaseHP -= p.dmg;
              hit = true;
            }
          }
          if (hit || p.x < 20 || p.x > br.width - 20) {
            try {
              p.el.remove();
            } catch (e) {}
            state.projectiles.splice(i, 1);
          }
        }
      }

      function findNearest(u) {
        let best = null,
          bd = Infinity;
        for (const o of state.units) {
          if (o.side === u.side) continue;
          if (o.hp <= 0) continue;
          const d = Math.abs(o.x - u.x);
          if (d < bd) {
            bd = d;
            best = o;
          }
        }
        if (!best && state.bossActive && u.side === "player") {
          const bossObj = state.units.find((z) => z.isBoss);
          if (bossObj) return bossObj;
          return {
            id: "BOSS",
            isBoss: true,
            x: battleEl.clientWidth - 120,
            hp: state.bossHP,
            side: "enemy",
          };
        }
        return best;
      }

      function updateUnits(dt) {
        const bw = battleEl.clientWidth;
        for (const u of state.units) {
          if (
            u.target &&
            (u.target.hp <= 0 || !state.units.includes(u.target))
          ) {
            u.target = null;
            u.attackingBase = false;
          }
        }
        for (const u of state.units) {
          if (u.attackingBase) {
            u.atkTimer += dt;
            if (u.atkTimer >= u.atkSpeed) {
              if (u.side === "player") {
                if (state.bossActive) {
                  state.bossHP -= u.atk;
                  const bo = state.units.find((z) => z.isBoss);
                  if (bo) bo.hp = state.bossHP;
                  if (state.bossHP <= 0) onBossDefeated();
                } else state.enemyBaseHP -= u.atk;
              } else state.playerBaseHP -= u.atk;
              u.atkTimer = 0;
            }
            continue;
          }
          if (u.side === "player") {
            const target = findNearest(u);
            u.target = target;
            if (u.template.type === "shoot") {
              const aim = target || null;
              const tx = aim
                ? aim.x !== undefined
                  ? aim.x
                  : bw - 140
                : bw - 140;
              const dist = Math.abs(tx - u.x);
              if (dist <= (u.template.range || 320)) {
                u.atkTimer += dt;
                if (u.atkTimer >= u.atkSpeed) {
                  createProjectile(u, aim || tx);
                  u.atkTimer = 0;
                }
              } else u.x += u.spd * 60 * dt;
            } else {
              if (target && Math.abs(target.x - u.x) <= 36) {
                u.atkTimer += dt;
                if (u.atkTimer >= u.atkSpeed) {
                  if (target.isBoss) {
                    state.bossHP -= u.atk;
                    const bo = state.units.find((z) => z.isBoss);
                    if (bo) bo.hp = state.bossHP;
                    if (state.bossHP <= 0) onBossDefeated();
                  } else target.hp -= u.atk;
                  u.atkTimer = 0;
                }
              } else {
                u.x += u.spd * 60 * dt;
                if (u.x + u.width >= bw - 160) {
                  u.attackingBase = true;
                  u.x = bw - 160 - u.width;
                }
              }
            }
          } else {
            const target = findNearest(u);
            u.target = target;
            if (u.template.type === "shoot") {
              const aim = target || null;
              const tx = aim ? (aim.x !== undefined ? aim.x : 140) : 140;
              const dist = Math.abs(tx - u.x);
              if (dist <= (u.template.range || 320)) {
                u.atkTimer += dt;
                if (u.atkTimer >= u.atkSpeed) {
                  createProjectile(u, aim || tx);
                  u.atkTimer = 0;
                }
              } else u.x -= u.spd * 60 * dt;
            } else {
              if (target && Math.abs(target.x - u.x) <= 36) {
                u.atkTimer += dt;
                if (u.atkTimer >= u.atkSpeed) {
                  if (!target.isBoss) target.hp -= u.atk;
                  else {
                    state.bossHP -= u.atk;
                    const bo = state.units.find((z) => z.isBoss);
                    if (bo) bo.hp = state.bossHP;
                    if (state.bossHP <= 0) onBossDefeated();
                  }
                  u.atkTimer = 0;
                }
              } else {
                u.x -= u.spd * 60 * dt;
                if (u.x <= 100) {
                  u.attackingBase = true;
                  u.x = 100;
                }
              }
            }
          }
        }
        for (let i = 0; i < state.units.length; i++) {
          for (let j = i + 1; j < state.units.length; j++) {
            const a = state.units[i],
              b = state.units[j];
            if (!a || !b || a.side === b.side) continue;
            if (Math.abs(a.x - b.x) < 36) {
              if (a.isBoss) {
                b.hp -= a.atk * 0.04;
                state.bossHP -= a.atk * 0.04;
              } else b.hp -= a.atk * 0.02;
              if (b.isBoss) {
                a.hp -= b.atk * 0.04;
                state.bossHP -= b.atk * 0.04;
              } else a.hp -= b.atk * 0.02;
            }
          }
        }
        const boss = state.units.find((u) => u.isBoss);
        if (boss) {
          if (
            boss.target &&
            (boss.target.hp <= 0 || !state.units.includes(boss.target))
          ) {
            boss.target = null;
            boss.attackingBase = false;
          }
          if (!boss.attackingBase) {
            const target = findNearest(boss);
            boss.target = target;
            if (target) {
              if (Math.abs(target.x - boss.x) > 50)
                boss.x -= boss.spd * 60 * dt;
            } else {
              boss.x -= boss.spd * 60 * dt;
              if (boss.x <= 100) {
                boss.attackingBase = true;
                boss.x = 100;
              }
            }
          }
        }
        for (let k = state.units.length - 1; k >= 0; k--) {
          const u = state.units[k];
          if (u.hp <= 0) {
            const died = state.units.splice(k, 1)[0];
            try {
              if (died.el) died.el.remove();
            } catch (e) {}
            if (died.isBoss) {
              state.bossHP = 0;
              onBossDefeated();
            } else if (died.side === "enemy" && !state.infiniteXP) {
              const baseCost = died.template.cost || 60;
              let xpMul = 0.4;
              let ageMultiplier = state.playerAge * 1.7;
              xpMul *= ageMultiplier;
              if (state.bossChoice && state.bossChoice.age >= 4) xpMul = 0.6;
              if (state.bossChoice && state.bossChoice.age === 6) xpMul = 1;
              if (state.bossChoice && state.bossChoice.age >= 4)
                ageMultiplier = state.playerAge * 2.2;
              if (state.bossChoice && state.bossChoice.age === 5)
                ageMultiplier = state.playerAge * 2.6;
              const xpGain = Math.round(baseCost * xpMul);
              const goldGain = Math.round(
                baseCost * (0.15 * (died.template.tier || 1)) +
                  (died.age * 2.5 || 1) * 6
              );
              if (state.bossChoice && state.bossChoice.age >= 5)
                (died.age * 2.5 || 1) * 8;
              state.xp += xpGain;
              state.gold += goldGain;
              showToast(
                L("killMsg") +
                  (state.lang === "ru" && died.template.ru
                    ? died.template.ru
                    : died.template.name) +
                  " +" +
                  xpGain +
                  " XP",
                900
              );
              updateUI();
            }
          }
        }
      }

      let bossWaveTimer = 0;
      function bossWaveTick(dt) {
        if (state.mode !== "boss") return;
        if (state.enemyBaseDestroyed) return;
        if (!state.bossChoice) return;
        if (state.stopEnemySpawn) return;
        bossWaveTimer -= dt;
        if (bossWaveTimer > 0) return;
        const elapsed = state.time;
        const rules = state.bossChoice.spawnRules || {
          allowMediumAfter: 30,
          allowHeavyAfter: 60,
        };
        let allowedTiers;
        if (elapsed < (rules.allowMediumAfter || 30)) allowedTiers = [1];
        else if (
          elapsed < (rules.allowHeavyAfter || rules.allowMediumAfter + 30)
        )
          allowedTiers = [1, 2];
        else allowedTiers = [1, 2, 3];
        const templates =
          UNIT_TEMPLATES[state.bossChoice.age] || UNIT_TEMPLATES[1];
        let pool = [];
        if (state.bossChoice.id >= 4) {
          if (allowedTiers.length === 2) {
            const rand = Math.random();
            if (rand < 0.85) pool = templates.filter((t) => t.tier === 1);
            else pool = templates.filter((t) => t.tier === 2);
          } else if (allowedTiers.length === 3) {
            const rand = Math.random();
            if (rand < 0.65) pool = templates.filter((t) => t.tier === 1);
            else if (rand < 0.9) pool = templates.filter((t) => t.tier === 2);
            else pool = templates.filter((t) => t.tier === 3);
          } else pool = templates.filter((t) => allowedTiers.includes(t.tier));
        } else {
          if (allowedTiers.length === 2) {
            const rand = Math.random();
            if (rand < 0.5) pool = templates.filter((t) => t.tier === 1);
            else pool = templates.filter((t) => t.tier === 2);
          } else if (allowedTiers.length === 3) {
            const rand = Math.random();
            if (rand < 0.33) pool = templates.filter((t) => t.tier === 1);
            else if (rand < 0.66) pool = templates.filter((t) => t.tier === 2);
            else pool = templates.filter((t) => t.tier === 3);
          } else pool = templates.filter((t) => allowedTiers.includes(t.tier));
        }
        const templ = pool.length
          ? pool[Math.floor(Math.random() * pool.length)]
          : templates[0];
        const bossAgeFactor = 1 + state.bossChoice.age * 0.3;
        const bossAccel = state.bossChoice.accel || 1.0;
        let interval = 1.6 * bossAgeFactor * (0.7 + Math.random() * 0.9);
        interval /= bossAccel;
        const diffFactor =
          { easy: 1.25, medium: 1.0, hard: 0.78 }[state.difficulty] || 1.0;
        interval *= diffFactor;
        bossWaveTimer = Math.max(0.6, interval);
        spawnUnit("enemy", templ);
      }

      function activateBoss() {
        state.bossActive = true;
        state.bossChoice =
          BOSSES.find((b) => b.id === state.chosenBossId) || BOSSES[0];
        const diffMul = DIFF[state.difficulty].bossMul || 1.0;
        state.bossHP = Math.round(state.bossChoice.baseHP * diffMul);
        state.enemyBaseDestroyed = true;
        playBossMusic();
        const br = battleEl.getBoundingClientRect();
        const el = document.createElement("div");
        el.className = "bossUnit";
        el.style.width = (state.bossChoice.imgWidth || 100) + "px";
        el.style.height = (state.bossChoice.imgHeight || 100) + "px";
        if (state.bossChoice.name === "Adolf Hitler")
          el.setAttribute("data-boss", "hitler");
        const img = document.createElement("img");
        img.src = `images/${state.bossChoice.name.toLowerCase()}.svg`;
        img.alt = state.bossChoice.name;
        el.appendChild(img);
        const hpBar = document.createElement("div");
        hpBar.className = "hpBar";
        const hpFill = document.createElement("div");
        hpFill.className = "hpFill";
        hpBar.appendChild(hpFill);
        el.appendChild(hpBar);
        if (battleUnits) battleUnits.appendChild(el);
        const bossObj = {
          id: "BOSS",
          template: state.bossChoice,
          side: "enemy",
          hp: state.bossHP,
          maxHp: state.bossHP,
          atk: Math.max(50, Math.floor(state.bossChoice.baseHP / 20)),
          spd: 0.25,
          x: br.width - 200,
          width: state.bossChoice.imgWidth || 100,
          el,
          atkTimer: 0,
          atkSpeed: 1.2,
          isBoss: true,
          attackingBase: false,
          target: null,
        };
        state.units.push(bossObj);
        updateTop();
      }

      function onBossDefeated() {
        if (state.bossDefeated) return;
        state.bossDefeated = true;
        state.bossActive = false;
        state.bossHP = 0;
        for (let i = state.units.length - 1; i >= 0; i--)
          if (state.units[i].isBoss) {
            try {
              state.units[i].el.remove();
            } catch (e) {}
            state.units.splice(i, 1);
          }
        const idx = BOSSES.findIndex((b) => b.id === state.bossChoice.id);
        if (idx >= 0 && idx < BOSSES.length - 1) {
          const next = BOSSES[idx + 1].id;
          if (!state.unlocked.includes(next)) {
            state.unlocked.push(next);
            saveUnlocked();
            showToast(
              L("unlockedBoss") +
                (state.lang === "ru"
                  ? BOSSES[idx + 1].ru
                  : BOSSES[idx + 1].name)
            );
          }
        } else {
          state.hackEnabled = true;
          // NEW: Mark that Future era has been completed
          state.futureCompleted = true;
        }
        playAgeMusic(state.playerAge);
        updateTop();
        showFinish(true, L("bossDefeated"));
      }

      function enemySpawnNormal(dt) {
        if (state.mode === "boss") return;
        if (state.bossActive || state.enemyBaseDestroyed) return;
        if (state.stopEnemySpawn) return;
        state.enemySpawnTimer -= dt;
        if (state.enemySpawnTimer > 0) return;
        const ramp = Math.min(state.time / 25000, 1);
        const spawnChance = 0.4 + 0.9 * ramp;
        if (Math.random() < spawnChance) {
          const templates = UNIT_TEMPLATES[state.enemyAge] || UNIT_TEMPLATES[1];
          let tierWeights = [1, 1, 1];
          if (state.time > 45) tierWeights = [1, 2, 1.5];
          if (state.time > 90) tierWeights = [1, 1.5, 2];
          let weightedTemplates = [];
          templates.forEach((t, i) => {
            for (let j = 0; j < tierWeights[i]; j++) weightedTemplates.push(t);
          });
          const t =
            weightedTemplates[
              Math.floor(Math.random() * weightedTemplates.length)
            ];
          spawnUnit("enemy", t);
        }
        const baseInterval =
          DIFF[state.difficulty].enemySpawnRate * (0.4 + Math.random() * 0.5);
        state.enemySpawnTimer = Math.max(0.06, baseInterval);
      }

      function enemyAgeTick(dt) {
        if (state.mode !== "none") return;
        if (state.enemyAge >= AGES.length) return;
        state.enemyAgeUpgradeCooldown -= dt;
        if (state.enemyAgeUpgradeCooldown <= 0) {
          const upgradeChance = 0.4 + state.enemyAge * 0.06;
          if (Math.random() < upgradeChance) {
            state.enemyAge++;
            state.enemyBaseHP = HP_PER_AGE[state.enemyAge - 1];
            showToast(
              state.lang === "ru"
                ? "–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–≤—ã—Å–∏–ª —ç–ø–æ—Ö—É"
                : "Enemy age increased"
            );
          }
          const speedMultiplier =
            DIFF[state.difficulty].enemyAgeUpgradeSpeed || 1.0;
          state.enemyAgeUpgradeCooldown =
            (20 + Math.random() * 20) / speedMultiplier;
        }
      }

      function renderAll() {
        if (!battleUnits) return;
        battleUnits.innerHTML = "";
        const bw = battleEl.clientWidth;
        for (const u of state.units) {
          const el = u.el;
          if (!el) continue;
          const hpFill = el.querySelector(".hpFill");
          const maxHP = u.maxHp || u.template.hp || 60;
          const pct = Math.max(0, Math.min(1, (u.hp || 0) / (maxHP || 1)));
          if (hpFill) {
            hpFill.style.width = pct * 100 + "%";
            if (pct < 0.35) hpFill.classList.add("low");
            else hpFill.classList.remove("low");
          }
          el.style.left = Math.max(60, Math.min(bw - 200, u.x)) + "px";
          el.style.bottom = u.isBoss ? "16%" : "14%";
          el.style.width =
            (u.isBoss
              ? u.template.imgWidth || 100
              : u.template.imgWidth || 60) + "px";
          el.style.height =
            (u.isBoss
              ? u.template.imgHeight || 100
              : u.template.imgHeight || 60) + "px";
          if (state.showHPNumbers) {
            let num = el.querySelector(".hpNum");
            if (!num) {
              num = document.createElement("div");
              num.className = "hpNum";
              num.style.position = "absolute";
              num.style.top = "-22px";
              num.style.left = "0";
              num.style.right = "0";
              num.style.fontSize = "10px";
              num.style.textAlign = "center";
              num.style.color = "#dbeafe";
              el.appendChild(num);
            }
            num.textContent = Math.round(u.hp) + " / " + Math.round(maxHP);
          }
          battleUnits.appendChild(el);
        }
        for (const p of state.projectiles)
          if (p.el && p.el.parentNode !== battleUnits)
            battleUnits.appendChild(p.el);
        if (state.bossActive && state.bossChoice) {
          const lbl = document.createElement("div");
          lbl.style.position = "absolute";
          lbl.style.right = "110px";
          lbl.style.top = "12%";
          lbl.style.padding = "6px 10px";
          lbl.style.background = "rgba(255,120,120,0.12)";
          lbl.style.borderRadius = "8px";
          lbl.style.fontWeight = "700";
          lbl.textContent =
            (state.lang === "ru"
              ? state.bossChoice.ru
              : state.bossChoice.name) +
            " (" +
            Math.max(0, Math.round(state.bossHP)) +
            ")";
          battleUnits.appendChild(lbl);
        }
        if (pHP) pHP.textContent = Math.max(0, Math.round(state.playerBaseHP));
        if (eHP) eHP.textContent = Math.max(0, Math.round(state.enemyBaseHP));
        updateTop();
        updateUI();
      }

      function updateUI() {
        const goldDisplay = document.getElementById("gold");
        const xpDisplay = document.getElementById("xp");
        const ageDisplay = document.getElementById("ageText");
        const ageCostDisplay = document.getElementById("ageCost");
        if (goldDisplay) {
          const displayGold = state.infiniteGold ? "‚àû" : Math.floor(state.gold);
          goldDisplay.textContent = displayGold;
        }
        if (xpDisplay) {
          const displayXP = state.infiniteXP ? "‚àû" : Math.floor(state.xp);
          xpDisplay.textContent = displayXP;
        }
        if (ageDisplay) {
          const ageName =
            state.lang === "ru"
              ? AGES[state.playerAge - 1].ru
              : AGES[state.playerAge - 1].name;
          ageDisplay.textContent = ageName;
        }
        if (ageCostDisplay) {
          const cost = XP_REQUIRED[state.playerAge - 1] || 9999;
          const currentXP = state.infiniteXP ? "‚àû" : Math.floor(state.xp);
          ageCostDisplay.textContent = `${currentXP}/${cost}`;
          if (state.xp >= cost || state.infiniteXP) {
            upgradeAge.classList.add("upgrade-age-blink");
            const mobileUpgrade = document.getElementById("mobileUpgradeAge");
            if (mobileUpgrade) mobileUpgrade.classList.add("upgrade-age-blink");
          } else {
            upgradeAge.classList.remove("upgrade-age-blink");
            const mobileUpgrade = document.getElementById("mobileUpgradeAge");
            if (mobileUpgrade)
              mobileUpgrade.classList.remove("upgrade-age-blink");
          }
        }
        updateStatLabels();
        updateMobileUI();
      }

      function updateStatLabels() {
        const statGold = document.getElementById("statGold");
        const statXP = document.getElementById("statXP");
        const statAge = document.getElementById("statAge");
        if (statGold)
          statGold.innerHTML =
            L("gold") +
            "<br><strong id='gold'>" +
            (state.infiniteGold ? "‚àû" : Math.floor(state.gold)) +
            "</strong>";
        if (statXP)
          statXP.innerHTML =
            L("xp") +
            "<br><strong id='xp'>" +
            (state.infiniteXP ? "‚àû" : Math.floor(state.xp)) +
            "</strong>";
        if (statAge) {
          const ageName =
            state.lang === "ru"
              ? AGES[state.playerAge - 1].ru
              : AGES[state.playerAge - 1].name;
          statAge.innerHTML =
            L("age") + "<br><strong id='ageText'>" + ageName + "</strong>";
        }
      }

      function updateHackUI() {
        if (!hackBtn) return;
        if (!state.hackEnabled) {
          hackBtn.style.display = "none";
          if (hackPopup) hackPopup.style.display = "none";
        } else hackBtn.style.display = "inline-block";
      }

      // Game loop
      let last = performance.now();
      function loop(now) {
        const rawDt = (now - last) / 1000;
        last = now;
        if (!state.running || state.timePaused) {
          requestAnimationFrame(loop);
          return;
        }
        const dt = rawDt * state.timeMultiplier;
        state.time += dt;
        const incomeMultiplier = DIFF[state.difficulty].incomeMultiplier || 1.0;
        if (!state.infiniteGold)
          state.gold += 3 * dt * (state.playerAge * 1.6) * incomeMultiplier;
        if (state.mode === "boss") bossWaveTick(dt);
        else {
          enemySpawnNormal(dt);
          enemyAgeTick(dt);
        }
        updateUnits(dt);
        updateProjectiles(dt);
        renderAll();
        updateUI();
        if (state.enemyBaseHP <= 0 && !state.enemyBaseDestroyed) {
          state.enemyBaseDestroyed = true;
          showToast(L("enemyBaseDestroyed"), 1000);
          if (state.mode === "boss") activateBoss();
          else showFinish(true, L("victoryBase"));
        }
        if (state.playerBaseHP <= 0) showFinish(false, L("defeatBase"));
        requestAnimationFrame(loop);
      }
      requestAnimationFrame(loop);

      function showFinish(win, message) {
        state.running = false;
        stopAllMusic();
        if (finishTitle)
          finishTitle.textContent = win ? L("victory") : L("defeat");
        if (finishMessage) finishMessage.textContent = message;
        if (finishOverlay) finishOverlay.style.display = "flex";
      }

      function startGame() {
        updateUI();
        if (state.mode === null) {
          showToast(state.lang === "ru" ? "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º" : "Choose mode");
          return;
        }
        state.running = true;
        state.gold =
          100 +
          (state.mode === "boss" && state.bossChoice
            ? state.bossChoice.age === 6
              ? state.bossChoice.age * 200
              : state.bossChoice.age >= 5
              ? state.bossChoice.age * 100
              : state.bossChoice.age === 4
              ? state.bossChoice.age * 50
              : state.bossChoice.age * 25
            : 0);
        state.xp = 0;
        state.playerAge = 1;
        state.enemyAge =
          state.mode === "boss" && state.bossChoice ? state.bossChoice.age : 1;
        state.playerBaseHP = HP_PER_AGE[state.playerAge - 1];
        state.enemyBaseHP = HP_PER_AGE[state.enemyAge - 1];
        state.units = [];
        state.projectiles = [];
        state.time = 0;
        state.enemySpawnTimer = 0;
        state.bossActive = false;
        state.bossHP = 0;
        state.enemyBaseDestroyed = false;
        state.bossDefeated = false;
        state.enemyAgeUpgradeCooldown = 45 + Math.random() * 20;
        state.timePaused = false;
        state.stopEnemySpawn = false;
        bossWaveTimer = 0;
        clearMenuBackground();
        buildUnitButtons();
        buildMobileUnitButtons();
        updateUI();
        buildBossList();
        if (menu) menu.style.display = "none";
        updateHackUI();

        // NEW: Hide upgrade button if Future era was completed in previous game
        if (state.futureCompleted) {
          upgradeAge.style.display = "none";
          const mobileUpgrade = document.getElementById("mobileUpgradeAge");
          if (mobileUpgrade) mobileUpgrade.style.display = "none";
        } else {
          upgradeAge.style.display = "flex";
          const mobileUpgrade = document.getElementById("mobileUpgradeAge");
          if (mobileUpgrade) mobileUpgrade.style.display = "flex";
        }

        playAgeMusic(state.playerAge);
      }

      function startBossGame() {
        if (!state.unlocked.includes(state.chosenBossId)) {
          showToast(L("chooseBossLocked"));
          return;
        }
        state.mode = "boss";
        state.bossChoice = BOSSES.find((b) => b.id === state.chosenBossId);
        startGame();
      }

      function localizeText() {
        const elements = {
          title: L("title"),
          btnNormal: L("normal"),
          btnBosses: L("bosses"),
          btnSettings: L("settings"),
          startNormal: L("startNormal"),
          startBoss: L("startBoss"),
          lblDiff: L("difficulty"),
          menuBtn: L("menu"),
          hackBtn: L("hack"),
          lblLang: L("language"),
          lblVolume: L("volume"),
          pauseTitle: L("paused"),
          pauseCancel: L("resume"),
          pauseMenu: L("returnMenu"),
          finishRestart: L("restart"),
          finishToMenu: L("toMenu"),
          lblYou: L("you"),
          lblEnemy: L("enemy"),
        };
        Object.keys(elements).forEach((id) => {
          const element = document.getElementById(id);
          if (element) element.innerHTML = elements[id];
        });
        const hackLabels = {
          hackLabelGold: L("infiniteGold"),
          hackLabelXP: L("infiniteXP"),
          hackLabelNoSpawn: L("enemyNoSpawn"),
        };
        Object.keys(hackLabels).forEach((id) => {
          const element = document.getElementById(id);
          if (element) element.textContent = hackLabels[id];
        });
        if (pauseTimeBtn) pauseTimeBtn.textContent = L("pauseTime");
        if (killEnemyBtn) killEnemyBtn.textContent = L("killEnemyUnits");
        if (killPlayerBtn) killPlayerBtn.textContent = L("killPlayerUnits");
        const statElements = {
          statGold: L("gold"),
          statXP: L("xp"),
          statAge: L("age"),
        };
        Object.keys(statElements).forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            const strong = element.querySelector("strong");
            if (strong) {
              element.innerHTML =
                statElements[id] +
                "<br><strong>" +
                (strong.id === "ageText"
                  ? state.lang === "ru"
                    ? AGES[state.playerAge - 1].ru
                    : AGES[state.playerAge - 1].name
                  : strong.textContent) +
                "</strong>";
            }
          }
        });
        if (upgradeAge) {
          const upgradeText = upgradeAge.querySelector(".upgrade-age-text");
          if (upgradeText) upgradeText.textContent = L("upgradeAge");
        }
        document.querySelectorAll(".diff-btn").forEach((btn) => {
          const diff = btn.dataset.diff;
          if (diff === "easy") btn.textContent = L("easy");
          else if (diff === "medium") btn.textContent = L("medium");
          else if (diff === "hard") btn.textContent = L("hard");
        });
        if (orientationWarning) {
          const h3 = orientationWarning.querySelector("h3");
          const p = orientationWarning.querySelector("p");
          if (h3) h3.textContent = L("pleaseRotate");
          if (p) p.textContent = L("rotateMessage");
        }
        updateTop();
      }

      function initializeEventListeners() {
        if (btnNormal)
          btnNormal.onclick = () => {
            panelNormal.style.display = "block";
            panelBosses.style.display = "none";
            panelSettings.style.display = "none";
            state.mode = "none";
            btnNormal.classList.add("active");
            btnBosses.classList.remove("active");
            btnSettings.classList.remove("active");
          };
        if (btnBosses)
          btnBosses.onclick = () => {
            panelBosses.style.display = "block";
            panelNormal.style.display = "none";
            panelSettings.style.display = "none";
            state.mode = "boss";
            buildBossList();
            btnNormal.classList.remove("active");
            btnBosses.classList.add("active");
            btnSettings.classList.remove("active");
          };
        if (btnSettings)
          btnSettings.onclick = () => {
            panelSettings.style.display = "block";
            panelNormal.style.display = "none";
            panelBosses.style.display = "none";
            btnNormal.classList.remove("active");
            btnBosses.classList.remove("active");
            btnSettings.classList.add("active");
          };
        document.querySelectorAll(".diff-btn").forEach((btn) => {
          btn.onclick = () => {
            document
              .querySelectorAll(".diff-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            state.difficulty = btn.dataset.diff;
          };
        });
        if (startNormal)
          startNormal.onclick = () => {
            state.mode = "none";
            startGame();
          };
        if (startBoss)
          startBoss.onclick = () => {
            if (!state.unlocked.includes(state.chosenBossId)) {
              showToast(L("chooseBossLocked"));
              return;
            }
            state.mode = "boss";
            state.bossChoice = BOSSES.find((b) => b.id === state.chosenBossId);
            startGame();
          };
        if (volRange) {
          volRange.oninput = () => {
            state.volume = parseFloat(volRange.value) / 100;
            const allMusic = [
              mainMusic,
              bossMusic,
              ancientMusic,
              antiquityMusic,
              medievalMusic,
              enlightenmentMusic,
              modernMusic,
              futureMusic,
              menuMusic,
            ];
            allMusic.forEach((music) => {
              if (music) music.volume = state.volume;
            });
          };
        }
        if (upgradeAge) {
          upgradeAge.onclick = () => {
            if (state.playerAge >= AGES.length) {
              showToast(
                state.lang === "ru"
                  ? "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–ø–æ—Ö–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!"
                  : "Maximum age reached!"
              );
              return;
            }
            const cost = XP_REQUIRED[state.playerAge - 1] || 9999;
            if (state.infiniteXP || state.xp >= cost) {
              if (!state.infiniteXP) state.xp -= cost;
              state.playerAge++;
              state.playerBaseHP = HP_PER_AGE[state.playerAge - 1];
              buildUnitButtons();
              buildMobileUnitButtons();
              playAgeMusic(state.playerAge);
              updateUI();
              showToast(
                (state.lang === "ru" ? "–ü–µ—Ä–µ—Ö–æ–¥ –≤ —ç–ø–æ—Ö—É: " : "Upgraded to ") +
                  (state.lang === "ru"
                    ? AGES[state.playerAge - 1].ru
                    : AGES[state.playerAge - 1].name)
              );
              if (state.playerAge >= AGES.length) {
                upgradeAge.style.display = "none";
                showToast(
                  state.lang === "ru"
                    ? "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–µ–¥–µ–ª –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!"
                    : "Technological limit reached!"
                );
              }
            } else showToast(L("notEnoughXP"));
          };
        }
        if (pauseCancel)
          pauseCancel.onclick = () => {
            pauseModal.style.display = "none";
            if (pauseModal._wasRunning) {
              state.running = true;
              requestAnimationFrame(loop);
            }
          };
        if (pauseMenu)
          pauseMenu.onclick = () => {
            pauseModal.style.display = "none";
            state.running = false;
            if (menu) menu.style.display = "flex";
            clearMenuBackground();
            createMenuBackground();
            playMenuMusic();
          };
        if (finishRestart)
          finishRestart.onclick = () => {
            if (finishOverlay) finishOverlay.style.display = "none";
            startGame();
          };
        if (finishToMenu)
          finishToMenu.onclick = () => {
            if (finishOverlay) finishOverlay.style.display = "none";
            state.running = false;
            if (menu) menu.style.display = "flex";
            clearMenuBackground();
            createMenuBackground();
            playMenuMusic();
          };
        function checkOrientation() {
          if (orientationWarning) {
            if (window.innerHeight > window.innerWidth)
              orientationWarning.style.display = "flex";
            else orientationWarning.style.display = "none";
          }
        }
        window.addEventListener("resize", checkOrientation);
        window.addEventListener("orientationchange", checkOrientation);
        checkOrientation();
        window.addEventListener("resize", checkUnitButtonsFit);
        document.addEventListener("click", function enableAudioOnInteraction() {
          if (!state.audioEnabled) enableAudio();
          document.removeEventListener("click", enableAudioOnInteraction);
        });
      }

      function init() {
        try {
          const raw = localStorage.getItem("aow_unlocked");
          if (raw) {
            const arr = JSON.parse(raw);
            if (Array.isArray(arr) && arr.length) state.unlocked = arr;
          }
        } catch (e) {}
        initializeLanguageSwitcher();
        buildBossList();
        buildUnitButtons();
        updateTop();
        updateUI();
        if (menu) menu.style.display = "flex";
        if (state.unlocked.length >= BOSSES.length) state.hackEnabled = true;
        updateHackUI();
        initializeHackMenu();
        initializeSpeedButtons();
        initializeMenuButton();
        initializeMobileControls();
        initializeEventListeners();
        localizeText();
        const allMusic = [
          mainMusic,
          bossMusic,
          ancientMusic,
          antiquityMusic,
          medievalMusic,
          enlightenmentMusic,
          modernMusic,
          futureMusic,
          menuMusic,
        ];
        allMusic.forEach((music) => {
          if (music) music.volume = 0;
        });
        createMenuBackground();
      }

      init();
    </script>
  </body>
</html>
